<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/admin_layout}"
	layout:fragment="Admin">

<main class="main-wrapper">
	<!-- 댓글내용 확인 모달창 -->
	<div id="modalReply" class="modal fade">
		<div class="modal-dialog">
			<div class="modal-content">
				<!-- 모달 헤더 -->
				<div class="modal-header">
					<h5 class="modal-title">등록 실패</h5>
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				<!-- 모달 본문 -->
				<div class="modal-body">
					<p style="text-align: center;">댓글을 입력해주세요!</p>
					<div style="text-align: center;">
						<img alt="등록완료버튼" th:src="@{/images/failed.png}">
					</div>
				</div>
				<!-- 모달 푸터 -->
				<div class="modal-footer">
					<button id='errBtn' type="button" class="btn btn-primary"
						data-dismiss="modal">확인</button>
				</div>
			</div>
		</div>
	</div>

	<!-- 등록완료 모달창 -->
	<div id="modal" class="modal fade">
		<div class="modal-dialog">
			<div class="modal-content">
				<!-- 모달 헤더 -->
				<div class="modal-header">
					<h5 class="modal-title">등록 완료</h5>
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				<!-- 모달 본문 -->
				<div class="modal-body">
					<p style="text-align: center;">등록이 완료되었습니다!</p>
					<div style="text-align: center;">
						<img alt="등록완료버튼" th:src="@{/images/registration.png}">
					</div>
				</div>
				<!-- 모달 푸터 -->
				<div class="modal-footer">
					<button id='okBtn' type="button" class="btn btn-primary close"
						data-dismiss="modal">확인</button>
				</div>
			</div>
		</div>
	</div>

	<!-- 대댓글 내용 확인 모달창 -->
	<div id="commentCentent" class="modal fade">
		<div class="modal-dialog">
			<div class="modal-content">
				<!-- 모달 헤더 -->
				<div class="modal-header">
					<h5 class="modal-title">등록 실패</h5>
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				<!-- 모달 본문 -->
				<div class="modal-body">
					<p style="text-align: center;">대댓글을 입력해주세요!</p>
					<div style="text-align: center;">
						<img alt="등록완료버튼" th:src="@{/images/failed.png}">
					</div>
				</div>
				<!-- 모달 푸터 -->
				<div class="modal-footer">
					<button id='errBtn' type="button" class="btn btn-primary"
						data-dismiss="modal">확인</button>
				</div>
			</div>
		</div>
	</div>
	<!-- 삭제 완료 모달창 -->
	<div id="deleteOK" class="modal fade">
		<div class="modal-dialog">
			<div class="modal-content">
				<!-- 모달 헤더 -->
				<div class="modal-header">
					<h5 class="modal-title">삭제 완료</h5>
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				<!-- 모달 본문 -->
				<div class="modal-body">
					<p style="text-align: center;">댓글이 삭제되었습니다!</p>
					<div style="text-align: center;">
						<img alt="등록완료버튼" th:src="@{/images/registration.png}">
					</div>
				</div>
				<!-- 모달 푸터 -->
				<div class="modal-footer">
					<button id='okBtn' type="button" class="btn btn-primary close"
						data-dismiss="modal">확인</button>
				</div>
			</div>
		</div>
	</div>
	<!-- 과제삭제 모달창 -->
	<div id="deleteHomework" class="modal fade">
		<div class="modal-dialog">
			<div class="modal-content">
				<!-- 모달 헤더 -->
				<div class="modal-header">
					<h5 class="modal-title">삭제 완료</h5>
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				<!-- 모달 본문 -->
				<div class="modal-body">
					<p style="text-align: center;">과제가 삭제되었습니다.</p>
					<div style="text-align: center;">
						<img alt="등록완료버튼" th:src="@{/images/registration.png}">
					</div>
				</div>
				<!-- 모달 푸터 -->
				<div class="modal-footer">
					<button id='checkBtn' type="button" class="btn btn-primary"
						onclick="location.href='homeworkT'">확인</button>
				</div>
			</div>
		</div>
	</div>
	<!-- 댓글 수정 모달 -->
	<div id="updateReply" class="modal fade">
		<div class="modal-dialog">
			<div class="modal-content">
				<!-- 모달 헤더 -->
				<div class="modal-header">
					<h5 class="modal-title">댓글 수정</h5>
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				<!-- 모달 본문 -->
					<div class="modal-body ">
						<input type="hidden" name="replyId">
						<textarea class="updateContent" style="border: 1px solid black;"
							rows="8" cols="50" placeholder="내용을 입력하세요"></textarea>
					</div>
					<!-- 모달 푸터 -->
					<div class="modal-footer">
						<button id='updateBtn' type="button" class="btn btn-primary" data-dismiss="modal">수정</button>
					</div>
			</div>
		</div>
	</div>
	<!-- 대댓글 수정 모달 -->
	<div id="updateComment" class="modal fade">
		<div class="modal-dialog">
			<div class="modal-content">
				<!-- 모달 헤더 -->
				<div class="modal-header">
					<h5 class="modal-title">대댓글 수정</h5>
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				<!-- 모달 본문 -->
					<div class="modal-body ">
					<input type="hidden" name="commentId">
						<textarea class=cUpdateContent style="border: 1px solid black;"
							rows="8" cols="50" placeholder="내용을 입력하세요"></textarea>
					</div>
					<!-- 모달 푸터 -->
					<div class="modal-footer">
						<button id='cUpdateBtn' type="button" class="btn btn-primary" data-dismiss="modal">수정</button>
					</div>
			</div>
		</div>
	</div>
	


	<!-- 과제 상세페이지 시작 -->
	<div th:each="homeworkInfo : ${homeworkList}">
		<button id="deleteHomeworks" th:value="${homeworkInfo.homeworkId}"
			class="main-btn light-btn rounded-full btn-hover"
			style="float: right;" type="button">과제 삭제</button>
		<div style="border: 1px solid black;">
			<hr>
			<h1>제목</h1>
			<p>[[${homeworkInfo.homeworkTitle}]]</p>
			<p style="float: right;">[[${#dates.format(homeworkInfo.homeworkDate,'yyyy년MM월dd일')}]]</p>
			<hr>
			<h2>내용</h2>
			<hr>
			<p>[[${homeworkInfo.homeworkContent}]]</p>
			<th:block th:each="file : ${files}">
				<p>
					<a th:href="|@{/homeworkdownload}/${file.downloadLocation}|">[[${file.homeworkfileName}]]</a>
				</p>
			</th:block>
		</div>
		<div style="border: 1px solid black;">
			<!-- 댓글출력 -->
			<h3>댓글</h3>
			<div id="replyList">
				<div id="replies"></div>
			</div>
		</div>
	</div>
	<!-- end reply -->
	<h3>댓글 작성</h3>
	<form name="insertReply" id="addReply" method="post"
		th:object="${homeworkList}" enctype="multipart/form-data">
		<input id="targetId" type="hidden" th:field="*{homeworkTargetId}">
		<input type="hidden" th:field="*{homeworkId}">
		<textarea style="border: 1px solid black;" rows="8" cols="50"
			placeholder="내용을 입력하세요" th:field="*{replyContent}"></textarea>
		<div class="col-12" style="text-align: center;">
			<input type="file" name="uploadFiles" multiple>
			<button id="insertBtn" class="main-btn primary-btn btn-hover"
				type="button">등록</button>
		</div>
	</form>
</main>

<script>


//과제 삭제
$('#deleteHomeworks').on('click',function(){
	let homeworkId = $('#deleteHomeworks').val();
	$.ajax({
		   url: "deleteHomeworks",
		   type: "delete",
		   data: {homeworkId : homeworkId},
		   success: function(data){
			   $('#deleteHomework').modal('show');
		   },
		   error: function(err){
			   alert("deleteHomeworks err");
		   }
	   });
	
})

	//--------------------------
	// 페이지 로드 시 댓글 목록 불러오기
	//--------------------------
	$().ready(function(){
		replyList();
		
	});
	
	
   //--------------------------
   //댓글 목록 불러오기 함수
   //--------------------------
   let replyId = 0;
   function replyList(){
      let targetId = $('#targetId').val();
      
      $.ajax({
         url : "replyList",
         type : "GET",
         data : {targetId:targetId},
         success : function(data){
            // 댓글 목록 초기화
            $('#replyList').empty(); 
            
            data.forEach(function(e){
               let replyDate = formatDate(e.replyDate);
               let replies = 
            	   `
            	   <input id="replyId" type="hidden" value="${e.replyId}">
            	   <div style="border: 1px solid black;">
            	   	<div>
                   		<p>댓글 내용 : <p id="replyContents">${e.replyContent}</p></p>
                   		<p>작성자 : ${e.replyWriter}</p>
                   		<p class="replyDate">작성일자 :${replyDate}</p>
                   	</div>	
                   		<div id="replyfiles-${e.replyId}"></div>
                   		<div class="col-12" style="text-align: right;">
							<button class="main-btn primary-btn btn-hover commentInput"	type="button" onclick="showReplyInput(${e.replyId})">답글</button>
							<button class="main-btn light-btn rounded-full btn-hover " type="button" onclick="deleteReply(${e.replyId})">댓글 삭제</button>
							<button class="main-btn warning-btn rounded-full btn-hover updateBtn" type="button" value="${e.replyId}" >댓글 수정</button>
						</div>
						<div id="comments-${e.replyId}">
							<div id="commentsList"></div>
						</div>
						
						<div id="${e.replyId}" style="display: none; margin-top: 10px;">
							<textarea id="comment-${e.replyId}" style="border: 1px solid black;" rows="4" cols="50" placeholder="답글 내용을 입력하세요"></textarea>
							<div class="col-12" style="text-align: center; margin-top: 10px;">
							<button class="main-btn primary-btn btn-hover commentInsertBtn" type="button" value="${e.replyId}" onclick="addComment(${e.replyId})">답글 등록</button>
							</div>
						</div>
                	</div>
                	`;
                	
               $('#replyList').append(replies);
             
               $('#comments-'+e.replyId).append(commentList(e.comments));
               $('#replyfiles-'+e.replyId).append(replyFile(e.replyId));
            });
            
            $('.updateBtn').on('click',function(e){
            	replyId = $(this).val();
            	
            	$('#updateReply').find('[name="replyId"]').val(replyId);
            	$('#updateReply').find('.updateContent').val($(this).closest('div').find('#replyContents').html());
            	let abc = $('#replyContents').html();
            	let content = $('.updateContent').val();
            	let cmt = $('.cUpdateContent').val();
            	console.log("지금 적혀있는 내용 = "+ content)
            	console.log("지금 적혀있는 abc = "+ abc)
            	
            	$('#updateReply').modal('show');
            })
         },
         error: function(err){
            alert("replyList 실패");
         }
      });
   }
	
   //--------------------------
   //댓글 수정 
   //--------------------------
   $('#updateBtn').on('click',function(data){
		let replyId = $('[name="replyId"]').val();
	  	let content = $('.updateContent').val();
	    
		$.ajax({
			url:"updateReply",
			type:'PUT',
			data: {content : content, replyId :replyId},
			success:function(data){
				$('#updateReply').modal('hide');
				$('#modal').modal('show');
				$('.updateContent').val('');
				replyList();
			},
			error : function(err){
				alert("update err")
			}
		})
		
	}) 
	
  
   
   //--------------------------
   // 댓글 등록 버튼 클릭 이벤트
   //--------------------------
   $('#insertBtn').on('click', addReply); 
   
   //--------------------------
   //댓글 등록 함수
   //--------------------------
   function addReply() {
      // 댓글 내용 없을 시 모달 띄움
      let replyContent = document.getElementById('replyContent');

      // 파일 업로드
      let formData = new FormData(document.getElementById('addReply'));
      if (replyContent.value == '') {
         $('#modalReply').modal('show');
         replyContent.focus();
         return;
      } else {
         $.ajax({
            url : "insertReply",
            type : "POST",
            processData : false, // QueryString(key=value)로 자동변환 무시
            contentType : false, // FormData가 가지고 있는 통신 정보를 사용
            data : formData,
            success : function(json) {
               $('#modal').modal('show');
               // 댓글 입력창 초기화
               replyContent.value = '';
               // 댓글 목록 새로고침
               replyList();
            },
            error : function(err) {
               alert("addReply err");
            }
         });
      }
   }
   
   //--------------------------
   //댓글 파일 다운로드
   //--------------------------
   function replyFile(replyId){
	   
	   $.ajax({
		   url : "replyfile",
		   type : "GET",
		   data : {replyId : replyId},
		   success : function(data){
			   data.forEach(function(e){
				   let replyfile = 
					   `
					   <a href="/replydownload/${e.downloadLocation}">${e.replyfileName}</a>
					   `
					   $('#replyfiles-'+e.replyId).append(replyfile);
			   })
		   },
		   error : function(err){
			 alert("replyfile err")  
		   }
	   });
   }
 	
    //-------------------
    // 대댓글 리스트
    //-------------------
   function commentList(comments){
	   
	        	 
	        	 comments.forEach(function(e){
	        		 
	        		 let commentDate = formatDate(e.commentDate);
	        		   let comments =
	        			 `<div>
	        			 	<p>작성자: ${e.commentWriter}</p>
	        			 	<p>대댓글 내용 : <p id="commentContent">${e.commentContent}</p></p>
	        			 	<p>대댓글 작성일자 : ${commentDate}</p>
	        			 	<button class="main-btn light-btn rounded-full btn-hover " type="button" onclick="(deleteComment(${e.commentId}))">답글 삭제</button>
	        			 	<button class="main-btn warning-btn rounded-full btn-hover cUpdateBtn" type="button" id="cUpdateBtn" value="${e.commentId}">답글 수정</button>
	        			 </div>
	        			 `
	        		 $('#comments-'+e.replyId).append(comments);
	        	 });
	        	 
	        	  $('.cUpdateBtn').on('click',function(e){
	             	commentId = $(this).val();
	             	$('#updateComment').find('[name="commentId"]').val(commentId);
	             	$('#updateComment').find('.cUpdateContent').val($(this).closest('div').find('#commentContent').html());
	             	//let asd = $('#commentContent').html();
	             	//console.log("내용 = " + asd);
	             	let cmt = $('.cUpdateContent').val();
	             	console.log("내용 = "+cmt)
	             	$('#updateComment').modal('show');
	             }) 
	   } 
   //--------------------------
   //대댓글 수정 
   //--------------------------
  $('#cUpdateBtn').on('click', function(data){
	   let commentId = $('[name="commentId"]').val();
	   let content = $('.cUpdateContent').val();
	   
	  $.ajax({
			url:"updateComment",
			type:'PUT',
			data: {content : content, commentId : commentId},
			success:function(data){
				$('#updateComment').modal('hide');
				$('#modal').modal('show');
				$('.cUpdateContent').val('');
				
				replyList();
			},
			error : function(err){
				alert("update err")
			}
		})
   });
   
   //--------------------------
   //대댓글 등록
   //--------------------------
   function addComment(replyId){
	   let content = $('#comment-'+replyId).val(); 
	   
	    if (content.value =='') {
	        alert('댓글 내용을 입력하세요.');
	        $('#modalReply').modal('show');
	        replyContent.focus();
	        return;
	    } else{
	    	
	   $.ajax({
		   url: 'insertComment',
		   type: 'post',
		   data :{replyId:replyId , content:content} ,
		   success: function(data){
			 $('#modal').modal('show');
			 content.value='';
			 replyList();
		   },
		   error : function(err){
			   alert('addComment err');
		   }
	   });  
	   }
   } 
   
   //--------------------------
   //대댓글 삭제
   //--------------------------
   function deleteComment(commentId){
	   
	   $.ajax({
		   url: "deleteComment",
		   type: "delete",
		   data: {commentId : commentId},
		   success: function(data){
			   $('#deleteOK').modal('show');
			   replyList();
		   },
		   error: function(err){
			   alert("deleteComment err");
		   }
	   });
   }
   
   //--------------------------
   //댓글 삭제
   //--------------------------
 	function deleteReply(replyId){
 		 $.ajax({
 			   url: "deleteReply",
 			   type: "delete",
 			   data: {replyId : replyId},
 			   success: function(data){
 				   $('#deleteOK').modal('show');
 				   replyList();
 			   },
 			   error: function(err){
 				   alert("deleteReply err");
 			   }
 		   });
   }
 	
 	
   //--------------------------
   // 답글 입력 창 보이기 함수
   //--------------------------
   function showReplyInput(replyId) {
       let replyInput = document.getElementById(replyId); 
      
      if (replyInput.style.display === 'none') {
         replyInput.style.display = 'block';
      } else {
         replyInput.style.display = 'none';
      }
   }
   
 	//--------------------------
   // 날짜 포맷 변환 함수
   //--------------------------
   function formatDate(date) {
      var d = new Date(date),
          month = '' + (d.getMonth() + 1),
          day = '' + d.getDate(),
          year = d.getFullYear();

      if (month.length < 2) month = '0' + month;
      if (day.length < 2) day = '0' + day;

      return [year, month, day].join('/');
   } 



  

</script>
</html>