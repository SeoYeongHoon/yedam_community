<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/admin_layout}"
	layout:fragment="Admin">
<style>
.admin{
	display : none;
}
.logName{
	display :none; 
}
</style>
<main class="main-wrapper">
	<!-- 댓글내용 확인 모달창 -->
	<div id="modalReply" class="modal fade">
		<div class="modal-dialog">
			<div class="modal-content">
				<!-- 모달 헤더 -->
				<div class="modal-header">
					<h5 class="modal-title">등록 실패</h5>
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				<!-- 모달 본문 -->
				<div class="modal-body">
					<p style="text-align: center;">댓글을 입력해주세요!</p>
					<div style="text-align: center;">
						<img alt="등록완료버튼" th:src="@{/images/failed.png}">
					</div>
				</div>
				<!-- 모달 푸터 -->
				<div class="modal-footer">
					<button id='errBtn' type="button" class="btn btn-primary"
						data-dismiss="modal">확인</button>
				</div>
			</div>
		</div>
	</div>

	<!-- 등록완료 모달창 -->
	<div id="modal" class="modal fade">
		<div class="modal-dialog">
			<div class="modal-content">
				<!-- 모달 헤더 -->
				<div class="modal-header">
					<h5 class="modal-title">등록 완료</h5>
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				<!-- 모달 본문 -->
				<div class="modal-body">
					<p style="text-align: center;">등록이 완료되었습니다!</p>
					<div style="text-align: center;">
						<img alt="등록완료버튼" th:src="@{/images/registration.png}">
					</div>
				</div>
				<!-- 모달 푸터 -->
				<div class="modal-footer">
					<button id='okBtn' type="button" class="btn btn-primary close"
						data-dismiss="modal">확인</button>
				</div>
			</div>
		</div>
	</div>

	<!-- 대댓글 내용 확인 모달창 -->
	<div id="commentCentent" class="modal fade">
		<div class="modal-dialog">
			<div class="modal-content">
				<!-- 모달 헤더 -->
				<div class="modal-header">
					<h5 class="modal-title">등록 실패</h5>
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				<!-- 모달 본문 -->
				<div class="modal-body">
					<p style="text-align: center;">대댓글을 입력해주세요!</p>
					<div style="text-align: center;">
						<img alt="등록완료버튼" th:src="@{/images/failed.png}">
					</div>
				</div>
				<!-- 모달 푸터 -->
				<div class="modal-footer">
					<button id='errBtn' type="button" class="btn btn-primary"
						data-dismiss="modal">확인</button>
				</div>
			</div>
		</div>
	</div>
	<!-- 삭제 완료 모달창 -->
	<div id="deleteOK" class="modal fade">
		<div class="modal-dialog">
			<div class="modal-content">
				<!-- 모달 헤더 -->
				<div class="modal-header">
					<h5 class="modal-title">삭제 완료</h5>
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				<!-- 모달 본문 -->
				<div class="modal-body">
					<p style="text-align: center;">댓글이 삭제되었습니다!</p>
					<div style="text-align: center;">
						<img alt="등록완료버튼" th:src="@{/images/registration.png}">
					</div>
				</div>
				<!-- 모달 푸터 -->
				<div class="modal-footer">
					<button id='okBtn' type="button" class="btn btn-primary close"
						data-dismiss="modal">확인</button>
				</div>
			</div>
		</div>
	</div>
	<!-- 과제삭제 모달창 -->
	<div id="deleteHomework" class="modal fade">
		<div class="modal-dialog">
			<div class="modal-content">
				<!-- 모달 헤더 -->
				<div class="modal-header">
					<h5 class="modal-title">삭제 완료</h5>
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				<!-- 모달 본문 -->
				<div class="modal-body">
					<p style="text-align: center;">과제가 삭제되었습니다.</p>
					<div style="text-align: center;">
						<img alt="등록완료버튼" th:src="@{/images/registration.png}">
					</div>
				</div>
				<!-- 모달 푸터 -->
				<div class="modal-footer">
					<button id='checkBtn' type="button" class="btn btn-primary"
						onclick="location.href='/admin/homework_T'">확인</button>
				</div>
			</div>
		</div>
	</div>


	<!-- 과제 상세페이지 시작 -->
	<input id="logId" type="hidden" th:value="${userId}">
	<input id="logName" type="hidden" th:value="${userName}">
	<div th:each="homeworkInfo : ${homeworkList}">
			<button id="deleteHomeworks" th:value="${homeworkInfo.homeworkId}"
				class="main-btn light-btn rounded-full btn-hover admin"
				style="float: right;" type="button">과제 삭제</button>
			<button id="updateHomework"
				class="main-btn warning-btn rounded-full btn-hover admin"
				th:value="${homeworkInfo.homeworkId}" type="button">게시글 수정</button>
		<div style="border: 1px solid black;">
			<hr>
			<h1>제목</h1>
			<input id="title" class="homeworkUpdate" type="text"
				style="padding: 10px; width: 250px; border: 1px solid black;"
				th:value="${homeworkInfo.homeworkTitle}" readonly>
			<h2>마감일자</h2>
			<input id="homeworkDate" class="homeworkUpdate" type="text"
				th:value="${#dates.format(homeworkInfo.homeworkDate,'yyyy-MM-dd')}"
				style="padding: 10px; width: 250px; border: 1px solid black;"
				readonly>
			<hr>
			<h2>내용</h2>
			<hr>
			<input id="content" class="homeworkUpdate" type="text"
				th:value="${homeworkInfo.homeworkContent}"
				style="padding: 10px; width: 250px; border: 1px solid black;"
				readonly>

			<!-- 파일내역 출력 -->
			<div id="homeworkFile"></div>
				<!-- 파일 업로드 -->
				<form method="post" enctype="multipart/form-data" id="updateForm" th:object="${homeworkVO}">
					<input id="homeworkId" type="hidden" th:value="${homeworkInfo.homeworkId}">
					<div id="file" style="padding: 50px; display: none;"
						class="card-style mb-30">
						<input type="file" name="uploadFiles" multiple="multiple">
						<button id="fileUpload" type="button"
							style="padding: 10px; width: 100px; border: 1px solid black;">파일
							등록</button>
					</div>
				</form>
			
			<button id=updateHomeworks class="main-btn primary-btn btn-hover"
				type="button" style="display: none;">등록</button>
		</div>
		<div style="border: 1px solid black;">

			<!-- 댓글출력 -->
			<h3>댓글</h3>
			<div id="replyList"></div>
		</div>
	</div>
	<!-- end reply -->
	<h3>댓글 작성</h3>
	<form name="insertReply" id="addReply" method="post"
		th:object="${homeworkList}" enctype="multipart/form-data">
		<input id="targetId" type="hidden" th:field="*{homeworkTargetId}">
		<input type="hidden" th:field="*{homeworkId}">
		<textarea style="border: 1px solid black;" rows="8" cols="50"
			placeholder="내용을 입력하세요" th:field="*{replyContent}"></textarea>
		<div class="col-12" style="text-align: center;">
			<input type="file" name="uploadFiles" multiple>
			<button id="insertBtn" class="main-btn primary-btn btn-hover"
				type="button">등록</button>
		</div>
	</form>
</main>

<script>

//--------------------------
// 페이지 로드 시 댓글 목록 불러오기
//--------------------------
$().ready(function(){
	let userId = $('#logId').val(); //로그인한 id
	console.log('userID == ' + userId);
	if(userId == 132){
		$('.admin').css('display','block');
	}
	
	replyList();
	fileList();
});

//과제 파일 목록

function fileList(){
	let homeworkId = $('#deleteHomeworks').val();
	$.ajax({
		url: '/all/homeworkFileList',
		type:'get',
		async: false,
		data:{homeworkId : homeworkId},
		success:function(data){
			data.forEach(function(e){
				let file =
					`
					<div>
						<p>
						<a class="filePath" value="${e.homeworkfileId}"  href="/homeworkdownload/${e.downloadLocation}">${e.homeworkfileName}</a>
							<button id="deleteFile-${e.homeworkfileId}" value="${e.homeworkfileLocation}" type="button" class="close deleteFile" style="float:left; display:none;" >&times;</button>
						</p>
					</div>
					`
					$('#homeworkFile').append(file);
					 deleteFile(e.homeworkfileId);
			})
			
		},
		error:function(err){
			alert("파일 리스트 오류")
		}
	})
}

// 과제 파일 삭제
function deleteFile(homeworkfileId){
	console.log("과제 파일 삭제 아이디 ==" + homeworkfileId)
$('#deleteFile-'+ homeworkfileId).on('click',function(){
	let homeworkfileLocation = $(this).val();
	
	$.ajax({
		url: '/all/deleteFile',
		type:'post',
		data:{homeworkfileLocation : homeworkfileLocation, homeworkfileId: homeworkfileId},
		success:function(e){
			 $('#homeworkFile').empty(); 
			fileList();
			$('.deleteFile').css('display', 'block');
		},
		error:function(err){
			alert('filedelete err')	
		}
	})
	
})
}


//과제 수정
$('#updateHomework').on('click',function(e){
	$('.homeworkUpdate').prop('readonly',false); // 수정할 input
	$('.homeworkUpdate').css('backgroundColor','yellow') // 수정할 input
	$('#updateHomeworks').css('display', 'block'); // 수정완료 버튼
	$('.deleteFile').css('display', 'block'); // 파일삭제 버튼
	$('#homeworkDate').prop('type','date'); // 마감일자 타입 변경
	$('#homeworkDate').val('');// 변경한 마감일자
	$('#file').css('display','block'); //파일업로드 버튼 
})
// 파일 업로드
$('#fileUpload').on('click',function(e){
	let homeworkId = $('#homeworkId').val();
	let formData = new FormData(document.getElementById('updateForm'));
	formData.append('homeworkId', homeworkId);
	$.ajax({
		url:'/admin/updateFile',
		type:'POST',
		processData: false, // QueryString(key=value)로 자동변환 무시
		contentType: false, // FormData가 가지고 있는 통신 정보를 사용
		data: formData,
		success:  function(result) {
			$('#modal').modal('show');
			$('#homeworkFile').empty(); 
			fileList();
			$('.deleteFile').css('display', 'block');
			
			
		},
		error: function(reject){	
			$('#modalError').modal('show');
           }
	})
	
})

$('#updateHomeworks').on('click',function(){
	let homeworkDate = $('#homeworkDate').val()
	let homeworkTitle = $('#title').val();
	let homeworkContent = $('#content').val();
	let homeworkId = $('#deleteHomeworks').val();
	$.ajax({
		url:"/admin/updateHomework",
		type: "put",
		data: {homeworkTitle : homeworkTitle, homeworkDate : homeworkDate , homeworkContent : homeworkContent, homeworkId : homeworkId},
		success:function(data){
			$('.homeworkUpdate').prop('readonly',false); //수정하고 인풋 readonly
			$('#updateHomeworks').css('display', 'none'); // 수정 등록버튼 
			$('.homeworkUpdate').css('backgroundColor','transparent') // 배경색 무로 변경
			$('.deleteFile').css('display', 'none'); // 파일삭제 버튼
			$('#modal').modal('show'); // 등록완료 모달
			$('#file').css('display','none'); //파일업로드 버튼 
		},
		error:function(err){
			alert("updateHomework err")
		}
	})
})


//과제 삭제
$('#deleteHomeworks').on('click',function(){
	let homeworkId = $('#deleteHomeworks').val();
	$.ajax({
		   url: "/admin/deleteHomeworks",
		   type: "delete",
		   data: {homeworkId : homeworkId},
		   success: function(data){
			   $('#deleteHomework').modal('show'); // 삭제완료 모달
		   },
		   error: function(err){
			   alert("deleteHomeworks err");
		   }
	   });
	
})


	
	
   //--------------------------
   //댓글 목록 불러오기 함수
   //--------------------------
   function replyList(){
      let targetId = $('#targetId').val();
      $.ajax({
         url : "/all/replyList",
         type : "GET",
         async: false,
         data : {targetId:targetId},
         success : function(data){
            // 댓글 목록 초기화
            $('#replyList').empty(); 
            
            data.forEach(function(e){
               let replyDate = formatDate(e.updateDate);
              
               let replies = 
            	   `
            	   <input id="replyId" type="hidden" value="${e.replyId}">
            	   <div class ="replyDiv"style="border: 1px solid black;">
            	   		<h3>댓글내용</h3>
            	   		<input class="replyContent-${e.replyId}" type="text" value="${e.replyContent}" readonly >
                   		<button type="button" class="main-btn warning-btn rounded-full btn-hover contentUpdate-${e.replyId}" style="display: none;"	>수정</button>
                   		<h3>작성자</h3>
                   		<input  id="logName" type="text" value="${e.replyWriter}" readonly >
                   		<h3>작성일자</h3>
                   		<input class="replyDate-${e.replyId}" type="text" value="${replyDate}"  readonly >
                   	</div>	
                   		<div id="replyFilesList"></div>
                   		<div class="col-12 " style="text-align: right;">
                   		<div id="replyFileUpload-${e.replyId}" style="display:none;">
		   					<form method="post" enctype="multipart/form-data" id="updateReplyForm">
		   						<input type="file" name="uploadReplyFile" multiple="multiple">
		   						<button class="updateReplyFile" value="${e.replyId}" type="button" style="padding: 10px; width: 100px; border: 1px solid black;">댓글 파일 등록</button>
		   					</form>
		   				</div>
							<button class="main-btn primary-btn btn-hover commentInput"	type="button" onclick="showReplyInput(${e.replyId})">답글</button>
							<button class="main-btn light-btn rounded-full btn-hover logName logName-${e.replyWriter}" type="button" onclick="deleteReply(${e.replyId})">댓글 삭제</button>
							<button class="main-btn warning-btn rounded-full btn-hover updateBtn logName logName-${e.replyWriter}" type="button" value="${e.replyId}" >댓글 수정</button>
						</div>
						<div id="comments-${e.replyId}">
							<div id="commentsList"></div>
						</div>
						
						<div id="${e.replyId}" style="display: none; margin-top: 10px;">
							<textarea id="comment-${e.replyId}" style="border: 1px solid black;" rows="4" cols="50" placeholder="답글 내용을 입력하세요"></textarea>
							<div class="col-12" style="text-align: center; margin-top: 10px;">
							<button class="main-btn primary-btn btn-hover commentInsertBtn" type="button" value="${e.replyId}" onclick="addComment(${e.replyId})">답글 등록</button>
							</div>
						</div>
                	</div>
                	`;
			
               $('#replyList').append(replies);
               $('#comments-'+e.replyId).append(commentList(e.comments));
               $('#replyfiles-'+e.replyId).append(replyFile(e.replyId));
               
            });
            //댓글 작성자 수정
       	 let userName = $('#logName').val() // 로그인한 Name
         let replyName = $('#logName').val()
         let console = $(".logName-"+userName).val()
         if(userName == replyName){
         $(".logName-"+userName).css('display','block');
         }
		 
       //대댓글 작성자 확인
    	 //let userName = $('#logName').val() // 로그인한 Name
          let commentName = $('.commentLogName').val()
          alert(commentName)
          if(userName == commentName){
          $(".commentLogName-"+userName).css('display','block');
          }
            /* 댓글 파일 업로드 */
            $('.updateBtn').on('click',function(e){
            	replyId = $(this).val();
            	$('.replyContent-'+replyId).prop('readonly',false);
            	$('.replyContent-'+replyId).css('backgroundColor','yellow');
            	$('.contentUpdate-'+replyId).css('display','block');
            	$('.deleteReplyFile').css('display','block');
            	$('#replyFileUpload-' + replyId).css('display','block'); // 댓글 파일 등록 출력
            	updateReply(replyId);
            }); 
            
            $('.updateReplyFile').on('click',function(e){
            	let replyId = $(this).val();
            	let formData = new FormData(document.getElementById('updateReplyForm'));
				formData.append('replyId', replyId);
				
				 $.ajax({
				        url: '/all/updateReplyFile',
				        type: 'POST',
				        processData: false, // 데이터 처리를 false로 설정
				        contentType: false, // 컨텐츠 타입을 false로 설정
				        data: formData, // FormData를 전송 데이터로 설정
				        success: function(result) {
				            $('#modal').modal('show');
				            $('#replyFilesList').empty();
				            replyFile(replyId);
				            $('.deleteReplyFile').css('display','block');
				        },
				        error: function(reject) {
				            $('#modalError').modal('show');
				        }
				    });
            	
			
            })
         },
         error: function(err){
            alert("replyList 실패");
         }
      });
   }
   

   //--------------------------
   // 댓글 등록 버튼 클릭 이벤트
   //--------------------------
   $('#insertBtn').on('click', addReply); 
   
   //--------------------------
   //댓글 등록 함수
   //--------------------------
   function addReply() {
      // 댓글 내용 없을 시 모달 띄움
      let replyContent = document.getElementById('replyContent');
      // 댓글 파일 업로드
      let formData = new FormData(document.getElementById('addReply'));
      if (replyContent.value == '') {
         $('#modalReply').modal('show');
         replyContent.focus();
         return;
      } else {
         $.ajax({
            url : "/all/insertReply",
            type : "POST",
            processData : false, // QueryString(key=value)로 자동변환 무시
            contentType : false, // FormData가 가지고 있는 통신 정보를 사용
            data : formData,
            success : function(json) {
               $('#modal').modal('show');
               // 댓글 입력창 초기화
               replyContent.value = '';
              // $('.replyContent').val('');
               // 댓글 목록 새로고침
               replyList();
            },
            error : function(err) {
               alert("addReply err");
            }
         });
      }
   }
   
   //--------------------------
   //댓글 파일 다운로드
   //--------------------------
   function replyFile(replyId){
	   
	   $.ajax({
		   url : "/all/replyfile",
		   type : "GET",
		   async: false,
		   data : {replyId : replyId},
		   success : function(data){
			   data.forEach(function(e){
				   let replyfile = 
					   `
					   <div id = "updateReplyFileList}">
					   		<input id="replyId" type="hidden" value="${e.replyId}">
					   		<input id="replyfileId" type="hidden" value="${e.replyfileId}">
					   		<a href="/replydownload/${e.downloadLocation}">${e.replyfileName}</a>
					   		<button id="deleteFile-${e.replyfileId}" value="${e.replyfileLocation}" type="button" class="close deleteReplyFile" style="float:left; display:none;" >&times;</button>
					   </div>
					   `
					   		$('#replyFilesList').append(replyfile);
			   })
			  
			   let replyfileId = $('#replyfileId').val();
			   deleteReplyFile(replyfileId)
		   },
		   error : function(err){
			 alert("replyfile err")  
		   }
	   });
   }
   
// 댓글 파일 삭제
   function deleteReplyFile(replyfileId){
	let replyId = $('#replyId').val();
   $('.deleteReplyFile').on('click',function(){
   	let path = $(this).val();
   	$.ajax({
   		url: '/all/deleteReplyFile',
   		type:'post',
   		data:{replyfileLocation : path, replyfileId: replyfileId, replyId : replyId},
   		success:function(data){
   			$('#replyFilesList').empty();
   			replyFile(data.replyId);
   			$('.deleteReplyFile').css('display','block');
   		},
   		error:function(err){
   			alert('filedelete err')	
   		}
   	})
   	
   })
   }
   
   //--------------------------
   //댓글 수정 
   //--------------------------
  function updateReply(replyId){
     $('.contentUpdate-'+replyId).on('click',function(data){
	  	let content = $('.replyContent-'+replyId).val();
	  	let date = $('.replyDate-'+replyId).val();
		$('#replyFiles-'+replyId).css('display','block'); // 업로드 버튼
		$.ajax({
			url:"/all/updateReply",
			type:'PUT',
			data: {replyContent : content, replyId :replyId, date : date},
			success:function(data){
				$('#modal').modal('show');
				$('#replyUpdate-'+replyId).prop('readonly',true);
				$('.replyfiles-'+ replyId).empty();
				replyList();
				$('#replyFilesList').empty();
				replyFile(replyId);
			},
			error : function(err){
				alert("update err")
			}
		})
		
	})   
   }
   

  

    //-------------------
    // 대댓글 리스트
    //-------------------
   function commentList(comments){
	   
	        	 
	        	 comments.forEach(function(e){
	        		 
	        		 let commentDate = formatDate(e.commentDate);
	        		   let comments =
	        			 `<div>
	        		   		<input class="commentLogName" type="hidden" value="${e.commentWriter}">
	        			 	<input class="commentContent-${e.commentId}" type="text" value="${e.commentContent}" readonly >
	        			 	<p>작성자: ${e.commentWriter}</p>
	        			 	<button type="button" class="main-btn warning-btn rounded-full btn-hover replyContentUpdate-${e.commentId}" style="display: none;"	>수정</button>
	        			 	<p >대댓글 작성일자 : ${commentDate}</p>
	        			 	<button class="main-btn light-btn rounded-full btn-hover logName commentLogName-${e.commentWriter}" type="button" onclick="(deleteComment(${e.commentId}))">답글 삭제</button>
	        			 	<button class="main-btn warning-btn rounded-full btn-hover cUpdateBtn logName commentLogName-${e.commentWriter}" type="button" id="cUpdateBtn" value="${e.commentId}">답글 수정</button>
	        			 </div>
	        			 `
	        		 $('#comments-'+e.replyId).append(comments);
	        	 });
	        	 
	        	 
	              
	              // 답글 수정
	        	  $('.cUpdateBtn').on('click',function(e){
	        		  let commentId = $(this).val();
	             	$('.commentContent-'+ commentId).prop('readonly',false);
	             	$('.commentContent-'+commentId).css('backgroundColor','yellow');
	            	$('.replyContentUpdate-'+commentId).css('display','block');
	            	replyUpdate(commentId);
	             }) 
	   } 
   //--------------------------
   //대댓글 수정 
   //--------------------------
  function replyUpdate(commentId){
  $('.replyContentUpdate-'+commentId).on('click', function(data){
	   let content = $('.commentContent-'+commentId).val();
	  $.ajax({
			url:"/all/updateComment",
			type:'PUT',
			data: {content : content, commentId : commentId},
			success:function(data){
				$('#modal').modal('show');
				$('.cUpdateContent').val('');
				replyList();
			},
			error : function(err){
				alert("update err")
			}
		})
   });
   }
   
   //--------------------------
   //대댓글 등록
   //--------------------------
   function addComment(replyId){
	   let content = $('#comment-'+replyId).val(); 
	   
	    if (content.value =='') {
	        alert('댓글 내용을 입력하세요.');
	        $('#modalReply').modal('show');
	        replyContent.focus();
	        return;
	    } else{
	    	
	   $.ajax({
		   url: '/all/insertComment',
		   type: 'post',
		   data :{replyId:replyId , content:content} ,
		   success: function(data){
			 $('#modal').modal('show');
			 content.value='';
			 replyList();
		   },
		   error : function(err){
			   alert('addComment err');
		   }
	   });  
	   }
   } 
   
   //--------------------------
   //대댓글 삭제
   //--------------------------
   function deleteComment(commentId){
	   
	   $.ajax({
		   url: "/all/deleteComment",
		   type: "delete",
		   data: {commentId : commentId},
		   success: function(data){
			   $('#deleteOK').modal('show');
			   replyList();
		   },
		   error: function(err){
			   alert("deleteComment err");
		   }
	   });
   }
   
   //--------------------------
   //댓글 삭제
   //--------------------------
 	function deleteReply(replyId){
 		 $.ajax({
 			   url: "/all/deleteReply",
 			   type: "delete",
 			   data: {replyId : replyId},
 			   success: function(data){
 				   $('#deleteOK').modal('show');
 				   replyList();
 			   },
 			   error: function(err){
 				   alert("deleteReply err");
 			   }
 		   });
   }
 	
 	
   //--------------------------
   // 답글 입력 창 보이기 함수
   //--------------------------
   function showReplyInput(replyId) {
       let replyInput = document.getElementById(replyId); 
      
      if (replyInput.style.display === 'none') {
         replyInput.style.display = 'block';
      } else {
         replyInput.style.display = 'none';
      }
   }
   
 	//--------------------------
   // 날짜 포맷 변환 함수
   //--------------------------
   function formatDate(date) {
      var d = new Date(date),
          month = '' + (d.getMonth() + 1),
          day = '' + d.getDate(),
          year = d.getFullYear();

      if (month.length < 2) month = '0' + month;
      if (day.length < 2) day = '0' + day;

      return [year, month, day].join('-');
   } 



  

</script>
</html>