<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/admin_layout}"
	layout:fragment="Admin">

<main class="main-wrapper">
	<!-- 댓글내용 확인 모달창 -->
	<div id="modalReply" class="modal fade">
		<div class="modal-dialog">
			<div class="modal-content">
				<!-- 모달 헤더 -->
				<div class="modal-header">
					<h5 class="modal-title">등록 실패</h5>
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				<!-- 모달 본문 -->
				<div class="modal-body">
					<p style="text-align: center;">댓글을 입력해주세요!</p>
					<div style="text-align: center;">
						<img alt="등록완료버튼" th:src="@{/images/failed.png}">
					</div>
				</div>
				<!-- 모달 푸터 -->
				<div class="modal-footer">
					<button id='errBtn' type="button" class="btn btn-primary"
						data-dismiss="modal">확인</button>
				</div>
			</div>
		</div>
	</div>

	<!-- 등록완료 모달창 -->
	<div id="modal" class="modal fade">
		<div class="modal-dialog">
			<div class="modal-content">
				<!-- 모달 헤더 -->
				<div class="modal-header">
					<h5 class="modal-title">등록 완료</h5>
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				<!-- 모달 본문 -->
				<div class="modal-body">
					<p style="text-align: center;">등록이 완료되었습니다.</p>
					<div style="text-align: center;">
						<img alt="등록완료버튼" th:src="@{/images/registration.png}">
					</div>
				</div>
				<!-- 모달 푸터 -->
				<div class="modal-footer">
					<button id='okBtn' type="button" class="btn btn-primary close"
						data-dismiss="modal">확인</button>
				</div>
			</div>
		</div>
	</div>

	<!-- 대댓글 내용 확인 모달창 -->
	<div id="commentCentent" class="modal fade">
		<div class="modal-dialog">
			<div class="modal-content">
				<!-- 모달 헤더 -->
				<div class="modal-header">
					<h5 class="modal-title">등록 실패</h5>
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				<!-- 모달 본문 -->
				<div class="modal-body">
					<p style="text-align: center;">대댓글을 입력해주세요!</p>
					<div style="text-align: center;">
						<img alt="등록완료버튼" th:src="@{/images/failed.png}">
					</div>
				</div>
				<!-- 모달 푸터 -->
				<div class="modal-footer">
					<button id='errBtn' type="button" class="btn btn-primary"
						data-dismiss="modal">확인</button>
				</div>
			</div>
		</div>
	</div>

	<!-- 과제 상세페이지 시작 -->
	<div th:each="homeworkInfo : ${homeworkList}">
		<div style="border: 1px solid black;">
			<hr>
			<h1>제목</h1>
			<p>[[${homeworkInfo.homeworkTitle}]]</p>
			<p style="float: right;">[[${#dates.format(homeworkInfo.homeworkDate,'yyyy년MM월dd일')}]]</p>
			<hr>
			<h2>내용</h2>
			<hr>
			<p>[[${homeworkInfo.homeworkContent}]]</p>
			<th:block th:each="file : ${files}">
				<p>
					<a th:href="|@{/homeworkdownload}/${file.downloadLocation}|">[[${file.homeworkfileName}]]</a>
				</p>
			</th:block>
		</div>
		<div style="border: 1px solid black;">
			<!-- 댓글출력 -->
			<h3>댓글</h3>
			<div id="replyList">
				<div id="replies"></div>
			</div>
		</div>
	</div>
	<!-- end reply -->
	<h3>댓글 작성</h3>
	<form name="insertReply" id="addReply" method="post"
		th:object="${homeworkList}" enctype="multipart/form-data">
		<input id="targetId" type="hidden" th:field="*{homeworkTargetId}">
		<input type="hidden" th:field="*{homeworkId}">
		<textarea style="border: 1px solid black;" rows="8" cols="50"
			placeholder="내용을 입력하세요" th:field="*{replyContent}"></textarea>
		<div class="col-12" style="text-align: center;">
			<input type="file" name="uploadFiles" multiple>
			<button id="insertBtn" class="main-btn primary-btn btn-hover"
				type="button">등록</button>
		</div>
	</form>
</main>

<script>
	// 페이지 로드 시 댓글 목록 불러오기
	$().ready(function(){
   		replyList(); 
	});

   //댓글 목록 불러오기 함수
   function replyList(){
      let targetId = $('#targetId').val();
      
      $.ajax({
         url : "replyList",
         type : "GET",
         data : {targetId:targetId},
         success : function(data){
            // 댓글 목록 초기화
            $('#replyList').empty(); 
            
            data.forEach(function(e){
            	alert("OK");
               let replyDate = formatDate(e.replyDate);
               let replyList = 
            	   `
            	   <div style="border: 1px solid black;">
                   		<p>댓글 내용 : ${e.replyContent}</p>
                   		<p>작성자 : ${e.replyWriter} ${e.commentContent}</p>
                   		<p class="replyDate">작성일자 :${replyDate}</p>
                   		<div class="col-12" style="text-align: right;">
							<button class="main-btn primary-btn btn-hover commentInput"	type="button" onclick="showReplyInput(${e.replyId})">답글</button>
						</div>
						<div id="${e.replyId}" style="display: none; margin-top: 10px;">
							<textarea id="comment-${e.replyId}" style="border: 1px solid black;" rows="4" cols="50" placeholder="답글 내용을 입력하세요"></textarea>
							<div class="col-12" style="text-align: center; margin-top: 10px;">
							<button class="main-btn primary-btn btn-hover commentInsertBtn" type="button" onclick="addComment(${e.replyId})">답글 등록</button>
							</div>
						</div>
                	</div>`;
               $('#replyList').append(replyList);
               
               
            });
         },
         error: function(err){
            alert("실패");
         }
      });
   }
   
   //대댓글 등록
   function addComment(replyId){
	   let content = $('#comment-'+replyId).val(); 
	   console.log(content);
	    if (content.value =='') {
	        alert('댓글 내용을 입력하세요.');
	    } else{
	   $.ajax({
		   url: 'insertComment',
		   type: 'post',
		   data :{replyId:replyId , content:content} ,
		   success: function(data){
			 content.value='';
			 replyList();
		   },
		   error : function(err){
			   alert('실패');
		   }
	   });  
	   }
   } 
   // 답글 입력 창 보이기 함수
   function showReplyInput(replyId) {
       let replyInput = document.getElementById(replyId); 
      
      if (replyInput.style.display === 'none') {
         replyInput.style.display = 'block';
      } else {
         replyInput.style.display = 'none';
      }
   }
   
   // 날짜 포맷 변환 함수
   function formatDate(date) {
      var d = new Date(date),
          month = '' + (d.getMonth() + 1),
          day = '' + d.getDate(),
          year = d.getFullYear();

      if (month.length < 2) month = '0' + month;
      if (day.length < 2) day = '0' + day;

      return [year, month, day].join('/');
   } 



   // 댓글 등록 버튼 클릭 이벤트
   $('#insertBtn').on('click', addReply); 
   
   //댓글 등록 함수
   function addReply() {
      // 댓글 내용 없을 시 모달 띄움
      let replyContent = document.getElementById('replyContent');

      // 파일 업로드
      let formData = new FormData(document.getElementById('addReply'));
      if (replyContent.value == '') {
         $('#modalReply').modal('show');
         replyContent.focus();
         return;
      } else {
         $.ajax({
            url : "insertReply",
            type : "POST",
            processData : false, // QueryString(key=value)로 자동변환 무시
            contentType : false, // FormData가 가지고 있는 통신 정보를 사용
            data : formData,
            success : function(json) {
               $('#modal').modal('show');
               // 댓글 입력창 초기화
               replyContent.value = '';
               // 댓글 목록 새로고침
               replyList();
            },
            error : function(err) {
               alert("error");
            }
         });
      }
   }

</script>
</html>