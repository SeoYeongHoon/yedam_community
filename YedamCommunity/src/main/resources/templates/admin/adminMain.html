<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{common/layouts/admin_layout}"
	  layout:fragment="Admin">
	<style>
		tr img {
			width: 80px;
		    max-width: 100%;
		    overflow: hidden;
		    margin-right: 15px;
		}
		
		.center {
		  text-align: center;
		  width: 60%;
		  margin: auto;
		}
		
		.adminPaging {
		  display: inline-block;
		}
		
		.adminPaging a {
		  color: black;
		  float: left;
		  padding: 8px 16px;
		  text-decoration: none;
		  transition: background-color .3s;
		  /*border: 1px solid #ddd;*/
		  /*margin: 0 4px;*/
		}
		
		.adminPaging a.active {
		  background-color: #4CAF50;
		  color: white;
		  border: 1px solid #4CAF50;
		}
		
		.adminPaging a:hover:not(.active) {
			background-color: #ddd;
		}
	</style>
	<script>
		
		//--------------------------------------------
		// 유저 정보 모달창에 출력
		//--------------------------------------------
		function fetchUserDetails(userId) {
	        // AJAX 요청
	        var xhr = new XMLHttpRequest();
	        xhr.open('GET', '/admin/userDetails?userId=' + userId, true);
	        xhr.onreadystatechange = function() {
	            if (xhr.readyState == 4 && xhr.status == 200) {
	                var user = JSON.parse(xhr.responseText);
	                console.log(user);
	                
	                document.getElementById('userName').textContent = user.name;
	                document.getElementById('userType').innerText = user.userType;
	                document.getElementById('curriculumId').textContent = user.curriculumId;
	                document.getElementById('userEmail').textContent = user.email;
	                document.getElementById('userTel').textContent = user.tel;
	                document.getElementById('userImage').src = '/images/profile/' + user.profileImageLocation;
	
	                document.querySelector('.infoModal').style.display = 'block';
	                document.querySelector('.approveUserBtn').style.display = 'none';
	                
	                // 삭제버튼
	                document.querySelector('.delUserBtn').addEventListener('click', function() {
	                	if (confirm('삭제하시겠습니까?')) {
	                		var xhr = new XMLHttpRequest();
					        xhr.open('GET', '/removeUser?userId=' + userId, true);
					        xhr.onreadystatechange = function() {
					            if (xhr.readyState == 4 && xhr.status == 200) {
					                var user = JSON.parse(xhr.responseText);
					
					                document.querySelector('.infoModal').style.display = 'none';
					                location.reload();
					            }
					        };
					        xhr.send();

			                alert('성공적으로 삭제되었습니다!');
	                	} else {
	                		return;
	                	}
	                	
	                });
	            }
	        };
	        xhr.send();
	    }
		
		// 회원가입 신청한 유저 정보 모달 출력
		function fetchReqDetails(registerId) {
	        // AJAX 요청
	        var xhr = new XMLHttpRequest();
	        xhr.open('GET', '/admin/reqDetails?registerId=' + registerId, true);
	        xhr.onreadystatechange = function() {
	            if (xhr.readyState == 4 && xhr.status == 200) {
	                var user = JSON.parse(xhr.responseText);
	                console.log(user);
	                
	                document.getElementById('userName').textContent = user.name;
	                document.getElementById('userType').innerText = user.userType;
	                document.getElementById('curriculumId').textContent = user.curriculumId;
	                document.getElementById('userEmail').textContent = user.email;
	                document.getElementById('userTel').textContent = user.tel;
	                document.getElementById('userImage').src = '/images/profile/' + user.profileImageLocation;
	
	                document.querySelector('.infoModal').style.display = 'block';
	                document.querySelector('.approveUserBtn').style.display = 'inline-block';
	                
	                // 삭제버튼
	                document.querySelector('.delUserBtn').addEventListener('click', function() {
	                	if (confirm('삭제하시겠습니까?')) {
	                		var xhr = new XMLHttpRequest();
					        xhr.open('GET', '/admin/refuseUser?registerId=' + registerId, true);
					        xhr.onreadystatechange = function() {
					            if (xhr.readyState == 4 && xhr.status == 200) {
					                var user = JSON.parse(xhr.responseText);
					
					                document.querySelector('.infoModal').style.display = 'none';
					                location.reload();
					            }
					        };
					        xhr.send();

			                alert('성공적으로 삭제되었습니다!');
	                	} else {
	                		return;
	                	}
	                	
	                });
	                
	                // (모달)회원가입 승인버튼
	                document.querySelector('.approveUserBtn').addEventListener('click', function() {
	                	if (confirm('회원가입을 승인하시겠습니까?')) {
	                		var xhr = new XMLHttpRequest();
	        		        xhr.open('GET', '/admin/insertUser?registerId=' + registerId, true);
	        		        xhr.onreadystatechange = function() {
	        		            if (xhr.readyState == 4 && xhr.status == 200) {
	        		                var user = JSON.parse(xhr.responseText);
	        		                console.log(user);
	        		                
	        		                /* document.querySelector('.approveBtn').style.display = 'none';
	        		                document.querySelector('.approved').style.display = 'inline-flex'; */
	        		                
	        		                closeInfoModal();
	        		            }
	        		        };
	        		        xhr.send();
	        		        
	                        alert('회원가입을 승인했습니다!');
	                        location.reload();
	        			} else {
	        				return;
	        			}
	                });
	            }
	        };
	        xhr.send();
	    }
		
		function closeInfoModal() {
			document.querySelector('.infoModal').style.display = 'none';
		}

		function openAddModal() {
			document.querySelector('.addModal').style.display = 'block';
		}
		function closeAddModal() {
			document.querySelector('.addModal').style.display = 'none';
		}
		
		// 회원가입 승인
		function approveRegister(registerId) {
			if (confirm('회원가입을 승인하시겠습니까?')) {
				var xhr = new XMLHttpRequest();
		        xhr.open('GET', '/admin/insertUser?registerId=' + registerId, true);
		        xhr.onreadystatechange = function() {
		            if (xhr.readyState == 4 && xhr.status == 200) {
		                var user = JSON.parse(xhr.responseText);
		                console.log(user);

		            }
		        };
		        xhr.send();
		        
                alert('회원가입을 승인했습니다!');
                location.reload();
			} else {
				return;
			}
			
		}

		function approveAll() {
	        var checkedItems = document.querySelectorAll('input[name="checkReqItem"]:checked');
	        var registerIds = Array.from(checkedItems).map(item => item.value);
			
			if (confirm("체크한 모든 인원을 승인하시겠습니까?")) {
				if (registerIds.length > 0) {
					var xhr = new XMLHttpRequest();
					xhr.open("POST", "/admin/insertCheckedUsers", true);
					xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
					xhr.onreadystatechange = function () {
						if (xhr.readyState == 4 && xhr.status == 200) {
							alert("선택된 항목들이 성공적으로 승인되었습니다.");
							location.reload();
						} else if (xhr.readyState == 4) {
							alert("승인 중 오류가 발생했습니다.");
						}
					};
					xhr.send(JSON.stringify({ registerIds: registerIds }));
				} else {
					alert('승인할 항목을 선택하세요.');
				}
			}
	        
	    }
		
		// 체크박스 전체체크
		function checkAll(item) {
	        checkboxes = document.getElementsByName('checkReqItem');
	        for (var i in checkboxes) {
	            checkboxes[i].checked = item.checked;
	        }
	    }
	</script>
	
	<!-- 어드민페이지 내부 컨텐트 -->
	<div id="adminContainer" style="min-height: 1300px;">
		<h1 class="mb-4 mt-4">예담 관리자 페이지</h1>
		
		<div class="tables-wrapper">

            <div class="row">
            	<div class="col-lg-12">
              
              		<!-- 회원가입 신청한 유저 리스트 -->
					<div class="card-style mb-30 request_wrapper"  style="position: relative; padding: 0;">
						<div class="table-top-content" style="height: 120px;">
							<h2 class="mb-10" style="color: white">회원가입 신청 관리</h6>
							<a href="#0" onclick="openAddModal()" class="modal_btn" style="background-color: #e96b56; padding: 7px; position: absolute; margin: 0; left: 15px; top: 70px;">수강생 일괄 등록 및 받기</a>
						</div>
						<div class="table-wrapper table-responsive" style="overflow-y: scroll; max-height: 500px;">
							<table class="table" style="padding: 0 30px;">
								<thead>
									<tr>
										<th>
											<input type="checkbox" value="checkAll" onclick="checkAll(this)">
										</th>
										<th>
											<h6>No</h6>
										</th>
										<th>
											<h6>유형</h6>
										</th>
										<th>
											<h6>이름</h6>
										</th>
										<th>
											<h6>연락처</h6>
										</th>
										<th>
											<h6>이메일</h6>
										</th>
										<th>
											<h6>상세정보</h6>
										</th>
										<th>
											<h6>승인유무</h6>
										</th>
									</tr>
								</thead>
								<tbody id="requestInfoTable">
									<tr th:each="req : ${requests}">
										<td>
											<input type="checkbox" name="checkReqItem" class="checkReqItem" th:value="${req.registerId}">
										</td>
										<td>
											<p>[[${req.registerId}]]</p>
										</td>
										<td>
											<p th:if="${req.userType} == 'ROLE_GRAD'">수료생</p>
											<p th:if="${req.userType} == 'ROLE_LEARN'">수강생</p>
										</td>
										<td>
											<p>[[${req.name}]]</p>
										</td>
										<td>
											<p>[[${req.tel}]]</p>
										</td>
										<td>
											<p>[[${req.email}]]</p>
										</td>
										<td>
											<a class="main-btn light-btn btn-hover" style="padding: 5px 10px;" th:onclick="'fetchReqDetails(' + ${req.registerId} + ')'">상세보기</a>
										</td>
										<td>
											<a th:onclick="'approveRegister(' + ${req.registerId} + ')'" href="#0" class="approveBtn main-btn dark-btn btn-hover" style="padding: 5px 10px;">승인하기</a>
										</td>
									</tr>
								</tbody>
							</table>
						</div>
						<div style="position: sticky; bottom: 0; width: 100%; padding: 10px; z-index: 99; background-color: white; box-shadow: 0px 0px 3px 0px #00000040;">
							<a href="#0" onclick="approveAll()" class="approveAllBtn main-btn dark-btn btn-hover" style="padding: 5px 10px;">일괄 승인</a>
						</div>
					</div>
               
                 
					<!-- 회원가입 된 유저리스트 -->
					<div class="card-style mb-30 request_wrapper" style="position: relative; max-height: 100%; padding: 0 0 30px 0;">
						<div class="table-top-content">
							<h2 class="mb-10" style="color: white">회원 관리</h6>
							<div class="select-style-1" style="display: flex; position: relative; margin-top: 20px; margin-bottom: 10px;">
								<div class="select-position" style="min-width: 140px;">
									<select name="userFilter" id="userFilter" style="padding: 10px; color: white; background-color: #e96b56;" onchange="filterUsers()">
										<option name="showAll" value="showAll" selected>전체</option>
										<option name="showGrad" value="showGrad">수료생</option>
										<option name="showLearn" value="showLearn">수강생</option>
									</select>
								</div>
							</div>
						</div>
						<div class="table-wrapper table-responsive" style="padding: 0 30px;"> <!-- overflow-y: scroll; max-height: 500px; -->
							<table class="table">
								<thead>
									<tr>
									<th>
										<h6>No</h6>
									</th>
									<th>
										<h6>유형</h6>
									</th>
									<th>
										<h6>이름</h6>
									</th>
									<th>
										<h6>연락처</h6>
									</th>
									<th>
										<h6>이메일</h6>
									</th>
									<th>
										<h6>상세정보</h6>
									</th>
									</tr>
								</thead>
								<tbody id="userInfoTable">
									<tr th:each="user : ${users}">
									<td>
										<p>[[${user.userId}]]</p>
									</td>
									<td>
										<p>[[${user.userType}]]</p>
									</td>
									<td>
										<p>[[${user.name}]]</p>
									</td>
									<td>
										<p>[[${user.tel}]]</p>
									</td>
									<td>
										<p>[[${user.email}]]</p>
									</td>
									<td>
										<a class="main-btn light-btn btn-hover" style="padding: 5px 10px;" th:onclick="'fetchUserDetails(' + ${user.userId} + ')'">상세보기</a>
									</td>
									</tr>
								</tbody>
							</table>
							
							<!-- <div class="center">
							    <div class="adminPaging">
							        <th:block th:if="${page.prev}">
							            <a href="javascript:void(0)" th:onclick="filterUsers(${page.starPage - 1})">&laquo;</a>
							        </th:block>
							        <th:block th:each="p : ${#numbers.sequence(page.starPage, page.endPage)}">
							            <a id="page_id" href="javascript:void(0)" th:onclick="'filterUsers(' + ${p} + ')'" th:class="${p == page.page} ? 'active'">[[${p}]]</a>
							        </th:block>
							        <th:block th:if="${page.next}">
							            <a href="javascript:void(0)" th:onclick="filterUsers(${page.endPage + 1})">&raquo;</a>
							        </th:block>
							    </div>
							</div> -->
							
							<div class="center">
							    <div class="adminPaging">
							        <th:block th:if="${page.prev}">
							            <a href="javascript:void(0)" th:onclick="filterUsers(${page.starPage - 1})">&laquo;</a>
							        </th:block>
							        <th:block th:each="p : ${#numbers.sequence(page.starPage, page.endPage)}">
							            <a id="page_id" href="javascript:void(0)" th:onclick="'filterUsers(' + ${p} + ')'">[[${p}]]</a>
							        </th:block>
							        <th:block th:if="${page.next}">
							            <a href="javascript:void(0)" th:onclick="filterUsers(${page.endPage + 1})">&raquo;</a>
							        </th:block>
							    </div>
							</div>
			                
			                <!-- 유저검색 -->
							<div class="input-style-1" style="position: absolute; bottom: 5px; ">
								<input name="id" type="text" placeholder="회원 검색" style="padding: 10px; width: 250px;">
								<img style="position: absolute; top: 12px; right: 10px; width: 20px; opacity: 0.5;" src="https://s3.ap-northeast-2.amazonaws.com/cdn.wecode.co.kr/icon/search.png">
							</div>
						</div>
					</div>
            	</div>
          	</div>
		</div>
	
		<!-- 일괄등록 모달 -->
		<div class="addModal">
			<div class="add_modal_popup" style="min-width: 800px; min-height: 300px;">
				<div class="add_modal_title center">
					<h4>수강생 일괄 등록 및 받기</h4>
					<a href="" class="modal_close" onclick="closeAddModal()">X</a>
				</div>
				<input class="addStdBtn" type="file" name="file" id="file" accept=".csv">
    
				<table class="table">
					<thead>
						<tr>
							<th>
								<input type="checkbox" value="checkAll" onclick="checkAll(this)">
							</th>
							<th><h6>과정명</h6></th>
							<th><h6>인원</h6></th>
							<th><h6>다운로드</h6></th>
						</tr>
					</thead>
					<tbody id="table-body">
						
					</tbody>
				</table>
				<div class="download_all">
					<a href="#0" class="main-btn dark-btn btn-hover" style="padding: 7px 5px;" onclick="downloadSelected()">선택 다운로드</a>
				</div>

				<!-- <input type="file" name="file" id="file">
				
				<table class="table">
					<thead>
						<th>
							<input type="checkbox" value="checkAll" onclick="checkAll(this)">
						</th>
						<th>
						<h6>과정명</h6>
						</th>
						<th>
						<h6>인원</h6>
						</th>
						<th>
						<h6>다운로드</h6>
						</th>
					</thead>
					<tbody>
						<tr>
							<td>
								<input type="checkbox" name="checkFileItem">
							</td>
							<td>
							<p>JAVA 기반 웹 프레임워크 양성과정 A</p>
							</td>
							<td>
							<p>23</p>
							</td>
							<td>
							<a href="#0" class="main-btn dark-btn-light btn-hover" style="padding: 7px 5px;">다운로드</a>
							</td>
						</tr>
					</tbody>
				</table>
				<div class="download_all">
					<a href="#0" class="main-btn dark-btn btn-hover" style="padding: 7px 5px;">선택 다운로드</a>
				</div> -->
			</div>
		</div>
		
		<!-- 상세정보 모달 -->
		<div class="infoModal">
			<div class="info_modal_popup" style="min-width: 700px; min-height: 300px;">
				<div class="add_modal_title center">
					<h4>상세정보</h4>
					<a href="#0" class="info_modal_close" onclick="closeInfoModal()">X</a>
				</div>
			
				<div id="info_profile" class="info_profile_content">
					<div class="info_image_wrapper">
						<img class="info_image" id="userImage" src="">
					</div>
					<div class="">
						<div class="" style="display: inline-flex; align-items: baseline; width: 100%;">
							<p class="info_type">이름</p>
							<span class="info_detail" id="userName"></span>
						</div>
						<div class="" style="display: inline-flex; align-items: baseline; width: 100%;">
							<p class="info_type">소속</p>
							<span class="info_detail" id="userType"></span>
						</div>
						<div class="" style="display: inline-flex; align-items: baseline; width: 100%;">
							<p class="info_type">수강 정보</p>
							<span class="info_detail" id="curriculumId"></span>
						</div>
						<div class="" style="display: inline-flex; align-items: baseline; width: 100%;">
							<p class="info_type">연락처</p>
							<span class="info_detail" id="userTel"></span>
						</div>
						<!-- <p class="info_type">수강 기간: <span id="curriculumDate"></span></p> -->
						<div class="" style="display: inline-flex; align-items: baseline; width: 100%;">
							<p class="info_type">이메일</p>
							<span class="info_detail" id="userEmail"></span>
						</div>
						
					</div>
				</div>
				<div class="download_all">
					<a href="#0" class="approveUserBtn main-btn dark-btn btn-hover" style="padding: 7px 5px; display: none;">승인하기</a>
					<a href="#0" class="delUserBtn main-btn danger-btn btn-hover" style="padding: 7px 5px;">회원삭제</a>
				</div>
			</div>
		</div>
		
	</div>
		
	<script>
	
		/* 일괄등록 모달 코드 */
		const addModal = document.querySelector('.addModal');
		const modalOpen = document.querySelector('.modal_btn');

		document.getElementById('file').addEventListener('change', handleFileSelect, false);

		function handleFileSelect(event) {
			const file = event.target.files[0];
			if (file) {
				const reader = new FileReader();
				reader.onload = function(e) {
					const contents = e.target.result;
					console.log("CSV file contents:", contents); // Log the CSV file contents
					parseCSV(contents);
				};
				reader.onerror = function(e) {
					console.error("File could not be read! Code " + e.target.error.code);
				};
				reader.readAsText(file);
			}
		}

		function parseCSV(data) {
			const rows = data.split('\n').map(row => row.split(','));
			console.log("Parsed rows:", rows); // Log the parsed rows
			const tableBody = document.getElementById('table-body');
			tableBody.innerHTML = '';
			rows.forEach((row, index) => {
				console.log("row: ", row, " index: ", index);
				if (row.length >= 2 && row[3].trim() && row[4].trim()) { // Ensure there are at least 2 columns and no empty rows
					const tr = document.createElement('tr');
					tr.innerHTML = `
						<td><input type="checkbox" name="checkFileItem"></td>
						<td><p>${row[3].trim()}</p></td>
						<td><p>${row[4].trim()}</p></td>
						<td><a href="#0" class="main-btn dark-btn-light btn-hover" style="padding: 7px 5px;" onclick="downloadRow(${index})">다운로드</a></td>
					`;
					tableBody.appendChild(tr);
				}
			});
		}

		/* function checkAll(source) {
			const checkboxes = document.getElementsByName('checkFileItem');
			for (let i = 0; i < checkboxes.length; i++) {
				checkboxes[i].checked = source.checked;
			}
		} */

		function downloadRow(index) {
			const tableBody = document.getElementById('table-body');
			const row = tableBody.rows[index];
			const courseName = row.cells[1].innerText;
			const participants = row.cells[2].innerText;
			const csvContent = `과정명,인원\n${courseName},${participants}`;
			const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
			const link = document.createElement('a');
			link.href = URL.createObjectURL(blob);
			link.download = `${courseName}.csv`;
			link.click();
		}

		function downloadSelected() {
			const checkboxes = document.getElementsByName('checkFileItem');
			let csvContent = '과정명,인원\n';
			for (let i = 0; i < checkboxes.length; i++) {
				if (checkboxes[i].checked) {
					const row = checkboxes[i].parentElement.parentElement;
					const courseName = row.cells[1].innerText;
					const participants = row.cells[2].innerText;
					csvContent += `${courseName},${participants}\n`;
				}
			}
			const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
			const link = document.createElement('a');
			link.href = URL.createObjectURL(blob);
			link.download = `selected_courses.csv`;
			link.click();
		}

	</script>
</html>