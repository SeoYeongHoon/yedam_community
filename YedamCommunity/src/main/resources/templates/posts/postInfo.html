<!DOCTYPE html>
<html
  xmlns:th="https://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{common/layouts/default_layout}"
  layout:fragment="Home"
>
  <head>
    <title>게시글 상세</title>
  </head>
  <body>
    <h1 th:text="${postInfo.title}">Post Title</h1>
    <p th:text="${postInfo.postContent}">Post Content</p>
    <p th:text="${postInfo.writer}">Post Writer</p>
    <p th:text="${#dates.format(postInfo.createDate, 'yyyy-MM-dd')}">Post Date</p>
    <p>조회수: <span th:text="${postInfo.postView}"></span></p>
    <p>좋아요: <span th:text="${postInfo.postLike}"></span></p>

    <!-- 이미지 출력 -->
    <h2>이미지</h2>
    <p>왜 이미지가 출력이 안되는걸까</p>
    <!-- <div th:each="file : ${postInfo.boardFiles}">
    </div> -->
    <!-- <img th:src="@{${postInfo.boardfileLocation}}" /> -->
    <img src="https://drive.google.com/drive/my-drive?hl=ko" >

    <h2>댓글</h2>
    <ul id="reply-list">
      <li th:each="reply : ${postInfo.replies}">
        <p th:text="${reply.replyContent}">Reply Content</p>
        <p th:text="${reply.replyWriter}">Reply Writer</p>
        <p th:text="${#dates.format(reply.replyDate, 'yyyy-MM-dd')}">
          Reply Date
        </p>
        <button type="button" class="delete-reply" th:data-reply-id="${reply.replyId}">
          댓글 삭제
        </button>

        <h3>대댓글</h3>
        <ul>
          <li th:each="comment : ${reply.comments}">
            <p th:text="${comment.commentContent}">Comment Content</p>
            <p th:text="${comment.commentWriter}">Comment Writer</p>
            <p th:text="${#dates.format(comment.commentDate, 'yyyy-MM-dd')}">
              Comment Date
            </p>
            <button type="button" class="delete-comment" th:data-comment-id="${comment.commentId}">
              대댓글 삭제
            </button>
          </li>
        </ul>

        <form class="comment-form">
          <input type="hidden" name="replyId" th:value="${reply.replyId}" />
          <input type="hidden" name="postId" th:value="${postInfo.postId}" />
          <textarea name="commentContent"></textarea>
          <button type="button" class="comment-submit">대댓글 작성</button>
        </form>
      </li>
    </ul>

    <h3>댓글 작성</h3>
    <form id="reply-form">
      <input type="hidden" name="postId" th:value="${postInfo.postId}" />
      <textarea name="replyContent"></textarea>
      <button type="button" id="reply-submit">댓글 작성</button>
    </form>

    <!-- 추천버튼 -->
    <button type="button" id="Good-submit">추천</button>

    <!-- 신고버튼 -->
    <button type="button" id="reportBtn">신고</button>

    <!-- 신고 폼 (모달 창으로 표시할 수도 있음) -->
    <div id="reportForm" style="display: none">
      <h3>게시글 신고</h3>
      <form id="report-form">
        <input type="hidden" name="postId" th:value="${postInfo.postId}" />
        <input type="hidden" name="boardId" th:value="${postInfo.boardId}" />
        <input type="hidden" name="reporter" th:value="${userId}" />
        <select name="reportType">
          <option value="1">부적절한 언어 사용</option>
          <option value="2">유해하거나 위험한 행위</option>
          <option value="3">성적인 내용</option>
          <option value="4">스팸 또는 혼동을 야기하는 콘텐츠</option>
        </select>
        <button type="button" id="report-submit">신고 제출</button>
      </form>
    </div>

    <a th:href="@{/postUpdate?postId={postId}(postId=${postInfo.postId})}"
      >수정</a>
    <form th:action="@{/postDelete}" method="get">
      <input type="hidden" name="postId" th:value="${postInfo.postId}" />
      <button type="submit">삭제</button>
    </form>
    <a th:href="@{/postList}">목록으로</a>

    <script>
      $(document).ready(function () {
        // 댓글 작성
        $("#reply-submit").on("click", function () {
          let formData = $("#reply-form").serialize();
          $.ajax({
            url: "addReply",
            type: "POST",
            data: formData,
            success: function (response) {
              alert("댓글이 등록되었습니다.");
            },
            error: function (error) {
              location.reload();
            },
          });
        });

        // 댓글 삭제
        $(".delete-reply").on("click", function () {
          let replyId = $(this).data("reply-id");
          if (confirm("댓글을 삭제하시겠습니까?")) {
            $.ajax({
              url: "deleteReply",
              type: "POST",
              data: { replyId: replyId },
              success: function (response) {
                alert("댓글이 삭제되었습니다.");
                location.reload();
              },
              error: function (error) {
                alert("댓글이 삭제 실패되었습니다.");
                location.reload();
              },
            });
          }
        });

        // 대댓글 작성
        $(".comment-submit").on("click", function () {
          let formData = $(this).closest("form").serialize();
          $.ajax({
            url: "addComment",
            type: "POST",
            data: formData,
            success: function (response) {
              alert("대댓글이 등록되었습니다.");
              location.reload();
            },
            error: function (error) {
              location.reload();
            },
          });
        });

        // 대댓글 삭제
        $(".delete-comment").on("click", function () {
          let commentId = $(this).data("comment-id");
          if (confirm("대댓글을 삭제하시겠습니까?")) {
            $.ajax({
              url: "deleteComment",
              type: "POST",
              data: { commentId: commentId },
              success: function (response) {
                alert("대댓글이 삭제되었습니다.");
                location.reload();
              },
              error: function (error) {
                console.log("Error:", error);
                alert("대댓글 삭제에 실패하였습니다.");
              },
            });
          }
        });
      });
      // 공백 방지 함수
      /*function validationCheck() {
            let content = $('textarea[name=replyContent]');
            if (title.val() === '') {
                alert('댓글내용은 필수로 입력해야합니다.');
                content.focus();
                return false;
            }
            return true;
        } */

      // 추천 추가 함수
      /* var postId = ${.postId};
		var userId = ${login.userId};
		var replyId = ${.replyId};
		
		 function updateLike(){ 
		     $.ajax({
		            type : "POST",  
		            url : "",       
		            dataType : "json",   
		            data : {'postId' : postId, 'userId' : userId , 'replyId' : replyId},
		            error : function(){
		               alert("통신 에러");
		            },
		            success : function(likeCheck) {
		                
		                    if(likeCheck == 0){
		                    	alert("추천완료.");
		                    	location.reload();
		                    }
		                    else if (likeCheck == 1){
		                     alert("추천취소");
		                    	location.reload();
		                }
		            }
		        });
		 } */

      //let reporter = ${login.userId}
      // 신고관련
      $(document).ready(function () {
        // 신고 버튼 클릭 시 폼 표시
        $("#reportBtn").on("click", function () {
          $("#reportForm").toggle();
        });

        // 신고 제출
        $("#report-submit").on("click", function () {
          let formData = $("#report-form").serialize();
          $.ajax({
            url: "reportPost",
            type: "POST",
            data: formData,
            success: function (response) {
              if (response === "success") {
                alert("신고가 접수되었습니다.");
                $("#reportForm").hide();
              } else {
                alert("신고 접수에 실패하였습니다.");
              }
            },
            error: function (error) {},
          });
        });
      });
    </script>
  </body>
</html>
