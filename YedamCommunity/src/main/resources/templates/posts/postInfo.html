<!DOCTYPE html>
<html
  xmlns:th="https://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{common/layouts/default_layout}"
  layout:fragment="Home">
  
<head>
  <title>게시글 상세</title>
</head>
<body>
<div class="container">
  <input type="hidden" name="userId" th:value="${postInfo.userId}" />
  <h1 th:text="${postInfo.title}">Post Title</h1>
  <p>조회수: <span th:text="${postInfo.postView}"></span></p>
  <p>좋아요: <span id="post-like-count" th:text="${postInfo.postLike}"></span></p>
  <p th:text="${#dates.format(postInfo.createDate, 'yyyy-MM-dd')}">Post Date</p>
  <p th:text="${postInfo.writer}">Post Writer</p>
  <p th:text="${postInfo.postContent}">Post Content</p>


  <h2 th:if="${#lists.size(postInfo.boardFiles) > 0}"></h2>
    <div th:each="file : ${postInfo.boardFiles}">
     <img th:if="${file.exists}" th:src="|/files/${file.boardfileLocation}|" style="width: 50%; height: auto;"/>
    </div>
  <div th:switch="${boardId}">
    <div th:case="2">
      <h3>구인구직 게시판 전용</h3>
      추가 콘텐츠를 여기에 추가
    </div>
    <div th:case="4">
      <h3>질문과 토론게시판 전용</h3>
      추가 콘텐츠를 여기에 추가
    </div>
  </div>

  <h2>댓글</h2>
  <ul id="reply-list">
    <li th:each="reply : ${postInfo.replies}" th:id="|'reply-' + ${reply.replyId}|">
      <p th:text="${reply.replyContent}">Reply Content</p>
      <p th:text="${reply.replyWriter}">Reply Writer</p>
      <p th:text="${#dates.format(reply.replyDate, 'yyyy-MM-dd')}">Reply Date</p>
      <button type="button" class="delete-reply" th:data-reply-id="${reply.replyId}">댓글 삭제</button>

      <h3>대댓글</h3>
      <ul>
        <li th:each="comment : ${reply.comments}" th:id="|'comment-' + ${comment.commentId}|">
          <p th:text="${comment.commentContent}">Comment Content</p>
          <p th:text="${comment.commentWriter}">Comment Writer</p>
          <p th:text="${#dates.format(comment.commentDate, 'yyyy-MM-dd')}">Comment Date</p>
          <button type="button" class="delete-comment" th:data-comment-id="${comment.commentId}">대댓글 삭제</button>
        </li>
      </ul>

      <form class="comment-form">
        <input type="hidden" name="replyId" th:value="${reply.replyId}" />
        <input type="hidden" name="postId" th:value="${postInfo.postId}" />
        <input type="hidden" name="boardId" th:value="${postInfo.boardId}" />
        <textarea name="commentContent"></textarea>
        <button type="button" class="comment-submit">대댓글 작성</button>
      </form>
    </li>
  </ul>

  <h3>댓글 작성</h3>
  <form id="reply-form">
    <input type="hidden" name="postId" th:value="${postInfo.postId}" />
    <input type="hidden" name="boardId" th:value="${postInfo.boardId}" />
    <textarea name="replyContent"></textarea>
    <button type="button" id="reply-submit">댓글 작성</button>
  </form>

  <!-- 추천버튼 -->
  <form class="Good-form">
    <input type="hidden" name="postId" th:value="${postInfo.postId}" />
    <input type="hidden" name="userId" th:value="${userId}" />
    <button type="button" class="Good-submit">추천</button>
  </form>

  <!-- 신고버튼 -->
  <button type="button" id="reportBtn">신고</button>

  <!-- 신고 폼 (모달 창으로 표시할 수도 있음) -->
  <div id="reportForm" style="display: none">
    <h3>게시글 신고</h3>
    <form id="report-form">
      <input type="hidden" name="postId" th:value="${postInfo.postId}" />
      <input type="hidden" name="boardId" th:value="${postInfo.boardId}" />
      <input type="hidden" name="reporter" th:value="${reporter}" />
      <select name="reportType">
        <option value="1">부적절한 언어 사용</option>
        <option value="2">유해하거나 위험한 행위</option>
        <option value="3">성적인 내용</option>
        <option value="4">스팸 또는 혼동을 야기하는 콘텐츠</option>
      </select>
      <button type="button" id="report-submit">신고 제출</button>
    </form>
  </div>
<div th:if="${isOwner}">
  <a th:href="@{/all/postUpdate/{boardId}/{postId}(boardId=${boardId}, postId=${postInfo.postId})}">수정</a>
  <form th:action="@{/all/postDelete/{boardId}/{postId}(boardId=${boardId}, postId=${postInfo.postId})}" method="get">
    <button type="submit">삭제</button>
  </form>
  </div>
  <a th:href="@{/all/post/{boardId}(boardId=${boardId})}">목록으로</a>
</div>
<script>
  $(document).ready(function () {
	  
	// --------------------------------------------
    // 댓글 작성
    // --------------------------------------------
    $(document).on("click", "#reply-submit", function () {
      let formData = new FormData(document.getElementById('reply-form'));
      $.ajax({
        url: "/all/Reply",
        type: "POST",
        processData: false, // QueryString(key=value)로 자동변환 무시
		contentType: false, // FormData가 가지고 있는 통신 정보를 사용
        data: formData,
        success: function (response) {
          alert("댓글이 등록되었습니다.");
          loadReplies();
        },
        error: function (error) {
          
        },
      });
    });
	
    // --------------------------------------------
    // 댓글 삭제
    // --------------------------------------------
    $(document).on("click", ".delete-reply", function () {
      let replyId = $(this).data("reply-id");
      if (confirm("댓글을 삭제하시겠습니까?")) {
        $.ajax({
          url: "/all/Reply",
          type: "DELETE",
          data: { replyId: replyId },
          success: function (response) {
        	  loadReplies();
          },
          error: function (error) {
        	  console.log("Error:", error);
            alert("댓글 삭제에 실패하였습니다.");
          },
        });
      }
    });
    
    // --------------------------------------------
    // 대댓글 작성
    // --------------------------------------------
    $(document).on("click", ".comment-submit", function () {
      let formData = $(this).closest("form").serialize();
      console.log(this);
      $.ajax({
        url: "/all/Comment",
        type: "POST",
        data: formData,
        success: function (response) {
        },
        error: function (error) {
        	loadReplies();
        },
      });
    });
    
    // --------------------------------------------
    // 대댓글 삭제
    // --------------------------------------------
    $(document).on("click", ".delete-comment", function () {
      let commentId = $(this).data("comment-id");
      if (confirm("대댓글을 삭제하시겠습니까?")) {
        $.ajax({
          url: "/all/Comment",
          type: "DELETE",
          data: { commentId: commentId },
          success: function (response) {
            loadReplies();
          },
          error: function (error) {
            console.log("Error:", error);
            alert("대댓글 삭제에 실패하였습니다.");
          },
        });
      }
    });
  });
  
  //--------------------------------------------
  // 추천 추가 함수
  // --------------------------------------------
  $(".Good-submit").on("click", function () {
    let formData = $(".Good-form").serialize();
    $.ajax({
      type: "POST",
      url: "/all/boardLike",
      dataType: "json",
      data: formData,
      success: function (likeCheck) {
        if (likeCheck == 0) {
          alert("추천완료");
          loadLikes();
        } else {
          alert("추천취소");
          loadLikes();
        }
      },
      error: function () {
        alert("통신 에러");
      },
    });
  });
  
  //---------------------------------------------
  // 신고관련
  // --------------------------------------------
  $(document).ready(function () {
    // 신고 버튼 클릭 시 폼 표시
    $("#reportBtn").on("click", function () {
      $("#reportForm").toggle();
    });

    // 신고 제출
    $("#report-submit").on("click", function () {
      let formData = $("#report-form").serialize();
      $.ajax({
        url: "/all/reportPost",
        type: "POST",
        data: formData,
        success: function (response) {
          if (response === "success") {
            alert("신고가 접수되었습니다.");
            $("#reportForm").hide();
          } else {
            alert("신고 접수에 실패하였습니다.");
          }
        },
        error: function (err) {
        	alert("에러");
        },
      });
    });
  });
  
  //---------------------------------------------
  // 댓글 로드
  //---------------------------------------------
  function loadReplies() {
    $.ajax({
      url: window.location.pathname,
      type: "GET",
      success: function (response) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(response, 'text/html');
        const newReplies = $(doc).find("#reply-list").html();
        $("#reply-list").html(newReplies);
      },
      error: function (error) {
        console.log("Error:", error);
      },
    });
  }
  
  //---------------------------------------------
  // 추천 로드
  //---------------------------------------------
 function loadLikes() {
      $.ajax({
        url: window.location.pathname,
        type: "GET",
        success: function (response) {
          const parser = new DOMParser();
          const doc = parser.parseFromString(response, 'text/html');
          const newLikesCount = $(doc).find("#post-like-count").text();
          $("#post-like-count").text(newLikesCount);
        },
        error: function (error) {
          console.log("Error:", error);
        },
      });
    }
  
</script>
</body>
</html>
