<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/admin_layout}"
	layout:fragment="Admin">
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<style>
#modalWrap {
	position: fixed; /* 화면에 고정 */
	z-index: 1; /* 상위에 위치 */
	padding-top: 200px;
	left: 0;
	top: 0;
	width: 100%;
	height: 100%;
	overflow: auto;
	background-color: rgba(0, 0, 0, 0.7); /* 반투명한 배경색 */
	display: none; /* 초기에는 숨김 */
}

#modalWrap2 {
	position: fixed; /* 화면에 고정 */
	z-index: 1; /* 상위에 위치 */
	padding-top: 200px;
	left: 0;
	top: 0;
	width: 100%;
	height: 100%;
	overflow: auto;
	background-color: rgba(0, 0, 0, 0.7); /* 반투명한 배경색 */
	display: none; /* 초기에는 숨김 */
}

#modalBody {
	width: 50%;
	height: 70%;
	padding: 30px 30px;
	margin: 0 auto;
	border: 1px solid #777;
	background-color: #fff;
}

#modalBody2 {
	width: 50%;
	height: 90%;
	padding: 30px 30px;
	margin: 0 auto;
	border: 1px solid #777;
	background-color: #fff;
}

.close-area {
	display: inline;
	float: right;
	padding-right: 10px;
	cursor: pointer;
	color: black;
}

li {
	display: inline;
}
tr img {
	width: 80px;
    max-width: 100%;
    overflow: hidden;
    margin-right: 15px;
}

.center {
  	text-align: center;
	  width: 60%;
	  margin: auto;
}

.testPaging {
  	
}

.testPaging a {
	  color: black;
	  float: left;
	  padding: 8px 16px;
	  text-decoration: none;
	  transition: background-color .3s;
	  /*border: 1px solid #ddd;*/
	  /*margin: 0 4px;*/
}

.testPaging a.active {
	  background-color: #4CAF50;
	  color: white;
	  border: 1px solid #4CAF50;
}

.testPaging a:hover:not(.active) {
		
}
</style>
<!-- <p th:text="${currList}"></p> -->
<div style="margin:10px; padding:10px">
	<button type="button" id="subBtn" style="margin-bottom: 10px;"
		class="main-btn primary-btn-light btn-hover">과목 추가/삭제</button>
	<ul>
		<li><a href="/admin/selectClassExam" id="testInsert"
			class="main-btn danger-btn-light btn-hover">다음</a></li>
		<li><a href="quizinsert"
			class="main-btn primary-btn-light btn-hover">새문제</a></li>
		<li><a href="#0" class="main-btn primary-btn-light btn-hover"
			id="quizSelect">문제선택</a></li>
		<li>
			<div id="subSelec" style="padding-top:10px;">
				<label>과목선택</label>
				<div class="select-position">
					<select id="subject" style="width:auto; height:30px;">
						<option value="all">문제 전체보기</option>
						<th:block th:each="subjectInfo, idxStat : ${subjectList}">
							<option class="typeSelec" th:value="${subjectInfo.subjectName}">[[${subjectInfo.subjectName}]]</option>
						</th:block>
					</select>
				</div>
			</div>
		</li>	
	</ul>
</div>
<div id="quizBox" class="container row" ></div>
<div class="center">
	<div class="testPaging">
		<!-- ajax실행으로 태그 생성 -->
	</div>
</div>


<!-- 문제 상세보기 모달창 -->
<div id="modalWrap" class="modal-overlay"></div>
<!-- 문제 상세보기 모달창 end-->

<!-- 과목추가/삭제 모달창 -->
<div id="modalWrap2" class="modal-overlay">
	<div id="modalBody2">
		<div class="close-area">X</div>
		<div class="input-style-1">
			<!-- 과정 선택창 -->
			<label>과정 선택</label>
				<div class="select-position">
					<select id="curr">
						<th:block th:each="currInfo, idxStat : ${currList}">
							<option class="typeSelec" th:value="${currInfo.curriculumId}" th:name="${currInfo.curriculumId}">[[${currInfo.curriculumName}]] - [[${currInfo.classId}]]강의실</option>
						</th:block>
					</select>
				</div>
		<form th:action="@{/subjectdelete}" id="delForm" name="delForm" method="get" th:object="${teacherVO}">
			<div class="card-style mb-30">
				<h6 class="mb-25">과목 설정</h6>
				<div class="form-check checkbox-style mb-20 currSub">
				</div>
				<input type="hidden" id="hidden" name="curriculumId"/>	
			</div>
			<button type="submit"
				class="main-btn danger-btn-light square-btn btn-hover" id="delBtn" formaction="subjectdelete">삭제</button>
		</form>	
		</div>
		<form th:action="@{/subjectinsert}" id="insertForm" name="insertForm" method="post" th:object="${teacherVO}">
			<div>
				<div class="input-style-1">
					<input type="text" id="insertSubName" placeholder="과목명을 입력하세요" th:field=*{subjectName}></input>
					<input type="hidden" id="insertSub"></input>
				</div>
				<button id="subAdd" class="main-btn primary-btn btn-hover"
					type="submit">과목추가</button>
			</div>
		</form>
	</div>
</div>
<!-- 과목추가 모달창 end -->
<script>
$(document).ready(function() {
	$('#subject').off('change').on('change', function() {
		quizContentList(1); // 필터 변경 시 1페이지부터 다시 시작
    });

    $('.testPaging').off('click', 'a').on('click', 'a', function() {
    	var page = $(this).data('page');
    	quizContentList(page);
    });
    
});

function testPagination(pageDTO, currentPage) {
	//console.log("pageDTO:", JSON.stringify(pageDTO, null, 12), "현재페이지:", currentPage);
	let arr = new Array();
	arr.push(pageDTO);
	//console.log("현재 페이지: " + arr[0].page);
	currentPage = arr[0].page;
			
	var pagination = $('.testPaging');
	pagination.empty();
			
	if (pageDTO.prev) {
		pagination.append('<a href="javascript:void(0)" data-page="' + (pageDTO.starPage - 1) + '" onclick="quizContentList(' + (pageDTO.starPage - 1) + ')">&laquo;</a>');
	}
			
	for (var p = pageDTO.starPage; p <= pageDTO.endPage; p++) {
		//console.log("p값: " + p);
				
		var pageLink = $('<a href="javascript:void(0)" data-page="' + p + '">' + p + '</a>');
				
		if (p === currentPage) {
			pageLink.addClass('active');
		} else {
			pageLink.addClass('none');
		}
				
		pageLink.attr('onclick', 'quizContentList(' + p + ')');
		pagination.append(pageLink);
	}
	if (pageDTO.next) {
		pagination.append('<a href="javascript:void(0)" data-page="' + (pageDTO.endPage + 1) + '" onclick="quizContentList(' + (pageDTO.endPage + 1) + ')">&raquo;</a>');
	}
}
</script>
<script>
var subName = ''; // 탬플릿문법안에 들어가있는 변수
var qContent = '';
var qId, sId= 0;
var page = 1;
var currentPage = 1;
var curriId = 0;
var solution = '';
var answer = [];
var subjectName = ''; // 필터링에 사용될 과목명
var textContent1 = '';
var textContent2 = '';
var textContent3 = '';
var textContent4 = '';
var textContent5 = '';
var storageContent = [];
var storageScore = []; 
var storageQId = [];

//--------------------------------------------
// 퀴즈 문제 전체를 불러오는 함수
//--------------------------------------------
function quizContentList(page, subjectName){
	//$('#quizBox').html('');
	subjectName = $('#subject').val();
	//--------------------------------------------
	// 문제 전체 조회 ajax (필터링)
	//--------------------------------------------
	$.ajax({
		url : "quizes",
		type : "get", 
		data : {
			page : page,
			subjectName : subjectName
		},
			
		success : function(data){
			updateList(data.quizes);
			testPagination(data.page,page);
			
			//--------------------------------------------
			// 문제 체크박스 버튼 누르고 문제선택 누를시 문제박스 색상 변경.
			//--------------------------------------------
			$('#quizSelect').on('click', function(index, e){
				$("input:checkbox[name=select]:checked").each(function(){
					$("input:checkbox[name=select]:checked").parent().parent().attr("style", "border-color:blue;")
				})
			})
			
			//--------------------------------------------	
			// 단건 조회 문제 불러오는(자세히보기 버튼) 함수 (ajax 포함) 시작
			//--------------------------------------------
			$('.box').on('click', '.infoBtn', function(qId) {
				$("#modalWrap").empty(); // 최초로 모달창 비워주는 기능 필요
				qId = $(this).val()
				answer = []; // 배열값 초기화
				//--------------------------------------------
				// 지문 자세히보기 - 모달에 불러오기 시작
				//--------------------------------------------
				$.ajax({
					url : "answers",
					type : "get", 
					data : {qId : qId},
									
					success : function(data){
						data.forEach((item,idx) => {
							answer.push(item.textContent);
						})
						textContent1 = answer[0];
						textContent2 = answer[1];
						textContent3 = answer[2];
						textContent4 = answer[3];
						textContent5 = answer[4];
						
						//--------------------------------------------
						// 문제,해설 단건조회(자세히보기)ajax - 모달에 불러오기 시작
						//--------------------------------------------
						$.ajax({
							url : "quizinfo",
							type : "get", 
							data : {qId : qId},
											
							success : function(data){
								data.forEach((item,idx) => {
									solution = item.quizSolution;
									qContent = item.quizContent;
									let qInfo = `
										<div id="modalBody">
											<div class="close-area">X</div>
												<h4>문제</h4><input type="text">${qContent}</input>
											<br><br><br>
											<div>
												<h4>보기</h4>
												<input type="text" id="textContent1">${textContent1}</input>
												<input type="text" id="textContent2">${textContent2}</input>
												<input type="text" id="textContent3">${textContent3}</input>
												<input type="text" id="textContent4">${textContent4}</input>
												<input type="text" id="textContent5">${textContent5}</input>
											</div>
											<br><br><br>
											<div>
												<h4>해설</h4><input type="text">${solution}</input>
											</div>
											<div style="text-align: center;" class="btnDiv">
												<button id="closeBtn" class="main-btn primary-btn btn-hover okBtn"
													type="button">확인</button>
												<button id="del${qId}" value="${qId}" class="main-btn primary-btn btn-hover quizDelBtn"
													type="button">삭제</button>	
											</div>
										</div>
										`;
									$("#modalWrap").append(qInfo);
									// 확인버튼 누르면 모달창 닫기
									$('.btnDiv').on('click', '.okBtn', function(){
										modal.style.display = "none";
									});
								})
							},
							error : function(err){
								console.log('에러입니다');
							}
						});
						//--------------------------------------------
						// 문제,해설 단건조회(자세히보기)ajax - 모달에 불러오기 종료
						//--------------------------------------------
					},
					error : function(err){
						console.log('에러입니다');
					}
				});
				//--------------------------------------------
				// 지문 자세히보기 - 모달에 불러오기 종료
				//--------------------------------------------
			})
			//--------------------------------------------	
			// 단건 조회 문제 불러오는(자세히보기 버튼) 함수 (ajax 포함) 종료
			//--------------------------------------------
			
			//--------------------------------------------	
			// 자세히 보기 버튼 눌렀을때 모달창 띄우기
			//--------------------------------------------
			$('#quizBox').on('click', '.infoBtn', function (e) {
				modal.style.display = "flex"; // 버튼 클릭시 모달 보임
			});
		},
		error : function(){
			alert('실패');
		}
	});
	//--------------------------------------------
	// 문제 전체 조회 ajax (필터링) 종료
	//--------------------------------------------
};
//--------------------------------------------
//퀴즈 문제 전체를 불러오는 함수 종료
//--------------------------------------------

//--------------------------------------------
// 과목 추가/삭제 모달창에서 과목창 띄워주는 함수
//--------------------------------------------
function subList(curriId){
	curriId = $('#curr').val();
	$('#insertSub').val(curriId);
	$('#insertSub').attr('name','curriculumId');
	$.ajax({
		url : "subjectCurrList",
		type : "post",
		data : {curriId : curriId},
		
		success : function(data){
			$('.currSub').html('');
			data.forEach((item,idx) => {
				
				let subjectName = item.subjectName;
				let templ = `
					<table>
						<tr>
							<th><input class="form-check-input checkbox"
								id="${subjectName}" type="checkbox"
								value="${subjectName}" name="subjectName" /> <label
								for="${subjectName}" class="form-check-label">${subjectName}</label>
							</th>
						</tr>
					</table>`;
				$('.currSub').append(templ);
			})
		},
		error : function(err){
			console.log('에러입니다');
		}
	}); 
}
subList(curriId);
//--------------------------------------------
//과목 추가/삭제 모달창에서 과정명이 바뀌면 과목명도 같이 바뀌는 필터, curriculumId값 자동 등록.
//--------------------------------------------
$('#curr').on('change', function(){
		curriId = $(this).val();
		$('#insertSub').val(curriId);
		$('#insertSub').attr('name','curriculumId');
		subList(curriId);
});
//--------------------------------------------
// 과목추가/삭제모달 알림창 뜨는거
//--------------------------------------------
document.querySelector('form[name="insertForm"]')
				.addEventListener('submit', validationCheck);
function validationCheck(event){
	event.preventDefault();
	if($('#insertSubName').val() == ''){
		alert('과목명을 입력해 주세요.');
		$('#insertSubName').focus();
		return;
	} else {
		alert('과목이 추가되었습니다');
		$('#insertForm').submit();
	}
}


$('#delBtn').on('click',function(){
	if($('#delBtn').submit()){
		//alert('과목이 삭제되었습니다.')
	} else {
		alert('오류 발생.')
	}
})

//--------------------------------------------
// 과목삭제에서 체크박스 누르고 삭제버튼 누를시 삭제되는 기능
//--------------------------------------------
$('.form-check').on('click', '.checkbox', function(){
	var chkVal = $(this).val();
	console.log(chkVal);
	console.log(curriId);
	$('input[type="checkbox"][name="subjectName"]').click(function(){
		  if($(this).prop('checked')){
		     $('input[type="checkbox"][name="subjectName"]').prop('checked',false);
		     $(this).prop('checked',true);
		    }
	});
	if($(".checkbox").is(":checked")){
		$('#hidden').val(curriId);
		$("#delBtn").attr("onclick", "location.href='/subjectdelete?subjectName=" + chkVal + '&curriculumId='+ curriId +"'");
		
	} else if($(".checkbox").is(":checked") == false){
		$("#delBtn").attr("onclick", "");
	};
})															

//--------------------------------------------
// 모달창 작업
//--------------------------------------------
// 모달창 (과목 추가/삭제)
//--------------------------------------------
const modalSub = document.getElementById("modalWrap2"); // 과목추가 모달창 요소 가져오기
const modal = document.getElementById("modalWrap"); // 자세히보기 모달창 요소 가져오기

$('#subBtn').on('click', function(e){
	modalSub.style.display = "flex"; // 과목추가/삭제 버튼 클릭시 모달창 보이기
});
//--------------------------------------------
// X버튼 누르면 모달창 닫기
//--------------------------------------------
$('.modal-overlay').on('click', '.close-area',function (){
	modal.style.display = "none";
	modalSub.style.display = "none";
});

//--------------------------------------------
// 모달창 밖에 화면 누르면 모달창 닫는 기능
//--------------------------------------------
modal.addEventListener("click", e => {
	const evTarget = e.target
	if(evTarget.classList.contains("modal-overlay")) {
		modal.style.display = "none"
	}
})
modalSub.addEventListener("click", e => {
    const evTarget = e.target
    if(evTarget.classList.contains("modal-overlay")) {
        modalSub.style.display = "none";
    }
});
//--------------------------------------------
// esc누르면 모달창 닫기
//--------------------------------------------
window.addEventListener("keyup", e => {
    if(modalSub.style.display === "flex" && e.key === "Escape") {
    	modalSub.style.display = "none";
    } else if(modal.style.display === "flex" && e.key === "Escape") {
    	modal.style.display = "none"
    }  
});
//--------------------------------------------
// 모달창 기능 종료
//--------------------------------------------

//--------------------------------------------
// 과목명 필터링해서 문제 출력
//--------------------------------------------
$('#subject').on('change', function(){
	console.log('셀렉트 바뀜');
	if($(this).val() == 'all'){
		console.log('과목선택이 전체선택')
		subjectName = '';
		quizContentList(page, subjectName);
	} else {
		console.log('과목선택이 다른것')
		subjectName = $(this).val();
		quizContentList(page, subjectName);
	}
});

//--------------------------------------------
// 시험출제 버튼 누르면 선택된 문제들이 localstorage에 저장되고 페이지가 넘어감.
//--------------------------------------------
$('#testInsert').on('click', function(){
	storageContent = [];
	storageScore = [];
	storageQId = [];
	storageSubName = [];
	let sum = 0;
	for(let i=0; i<$('.box').length; i++){
		if($('#qContent'+i).is(":checked")){
			storageContent.push($('#qContent'+i).val());
			storageScore.push($('#qScore'+i).val());
			storageQId.push($('#qId'+i).val());
			storageSubName.push($('#sName'+i).val());
			
			sum += parseInt($('#qScore'+i).val());
		}
	}
	// 배점 총합이 0점일때 NaN 뜨는거 0으로 변경.
	if(isNaN(sum)){
		sum = 0;
	}
	// 문제를 선택(체크) 하지 않은 경우 알람창
	if($('input[name="select"]:checked').length == 0){
		alert('문제가 선택되지 않았습니다.\n문제를 선택해주세요.')
		return false;
	}
	// 배점의 총합이 100이 됐는지 체크
	if(sum == 100){
		alert('배점의 합이 100점입니다.\n다음으로 넘어갑니다.')
		
	} else {
		alert('배점의 합을 100점으로 맞춰주세요.\n' + '현재 배점 총합 : ' + sum)
		return false;
	}
	
	// 값 저장시 ["","",""] 배열타입으로 저장하기 위해 변환작업.
	const arryContent = JSON.stringify(storageContent);
	const arryScore = JSON.stringify(storageScore); 
	const arryQid = JSON.stringify(storageQId);
	const arrySName = JSON.stringify(storageSubName);
	
	// 위 작업 안하면 값 출력시 그냥 1,2,3 이런식으로 출력됨
	// 위 작업을 하게 될 경우 ["1","2","3"] 이렇게 출력됨
	window.localStorage.setItem('quizContent', arryContent);
	window.localStorage.setItem('quizScore', arryScore);
	window.localStorage.setItem('quizId', arryQid);
	window.localStorage.setItem('subjectName', arrySName);
})

//--------------------------------------------
// 등록된 문제 필터링으로 인한 리스트 업데이트
//--------------------------------------------
function updateList(quizes){
	$('#quizBox').html('');
	
	quizes.forEach((quiz,idx) => {
		subName = quiz.subjectName;				
		qContent = quiz.quizContent;
		qId = quiz.quizId;
		sId = quiz.subjectId;
		
		let temp = `
			<div style="color:gray;" class="col-3 box" id="${qId}">
				<div class="card-style-3 mb-30 box2">
					<div>
							<input type="checkbox" class="quizChk " name="select"  id="qContent${idx}" value="${qContent}" style="zoom : 1.3"></input>
						<label>문제선택</label>
						
						<input type="text" class="scInput" placeholder="배점입력" id="qScore${idx}" style="border:1px solid black; width: 70px;">
						<p>과목명 : ${subName}</p>
						<input type="hidden" id="qId${idx}" value="${qId}" />
						<input type="hidden" id="sName${idx}" value="${subName}" />
					</div>
					<div class="card-content">
						<h4>${qContent}</h4>
						<br>
						<button type="button" class="infoBtn" name="${qId}" value="${qId}">자세히 보기</button>
					</div>
				</div>
			</div>
			`;
		$("#quizBox").append(temp);
	}) // for문 종료
} // 함수 종료

window.onload = function() {
	quizContentList(page, subjectName);
}

//--------------------------------------------
// 재시험 출력 페이지에서 넘어오면 다음 버튼 눌렀을때 reCurriculumId값을 가져오게 된다.
//--------------------------------------------
let reCurriculumId = window.localStorage.getItem('reCurriculumId')

if(reCurriculumId == null || reCurriculumId == ""){
	console.log("reCurriculumId 값이 없다 : " + reCurriculumId)
	$('#testInsert').attr('href', 'admin/selectClassExam')
} else {
	$('#testInsert').attr('href', 'retestinsert')
};	

$('#modalWrap').on('click', '.quizDelBtn', function(){
	console.log($(this).val());
	let quizId = $(this).val();
	$.ajax({
		url : "quizdelete",
		type : "get",
		data : {quizId : quizId},
		
		success : function(data){
			location.reload();
		},
		error : function(err){
			console.log('에러입니다');
		}
	}); 
})

</script>

</html>