<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/admin_layout}"
	layout:fragment="Admin">
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<style>
#modalWrap {
	position: fixed; /* 화면에 고정 */
	z-index: 1; /* 상위에 위치 */
	padding-top: 200px;
	left: 0;
	top: 0;
	width: 100%;
	height: 100%;
	overflow: auto;
	background-color: rgba(0, 0, 0, 0.7); /* 반투명한 배경색 */
	display: none; /* 초기에는 숨김 */
}

#modalWrap2 {
	position: fixed; /* 화면에 고정 */
	z-index: 1; /* 상위에 위치 */
	padding-top: 200px;
	left: 0;
	top: 0;
	width: 100%;
	height: 100%;
	overflow: auto;
	background-color: rgba(0, 0, 0, 0.7); /* 반투명한 배경색 */
	display: none; /* 초기에는 숨김 */
}

#modalBody {
	width: 50%;
	height: 70%;
	padding: 30px 30px;
	margin: 0 auto;
	border: 1px solid #777;
	background-color: #fff;
}

#modalBody2 {
	width: 50%;
	height: 90%;
	padding: 30px 30px;
	margin: 0 auto;
	border: 1px solid #777;
	background-color: #fff;
}

.close-area {
	display: inline;
	float: right;
	padding-right: 10px;
	cursor: pointer;
	color: black;
}

li {
	display: inline;
}
</style>
<!-- <p th:text="${answerList}"></p>  -->
<div>
	<button type="button" id="subBtn"
		class="main-btn primary-btn-light btn-hover">과목 추가/삭제</button>
	<ul>
		<li>
			<div id="subSelec">
				<label>과목선택</label>
				<div class="select-position">
					<select id="subject">
						<option value="all">전체보기</option>
						<th:block th:each="subjectInfo, idxStat : ${subjectList}">
							<option class="typeSelec" th:value="${subjectInfo.subjectName}">[[${subjectInfo.subjectName}]]</option>
						</th:block>
					</select>
				</div>
			</div>
		</li>
		<li><a href="selectClassExam"
			class="main-btn danger-btn-light btn-hover">시험출제</a></li>
		<li><a href="quizinsert"
			class="main-btn primary-btn-light btn-hover">새문제</a></li>
		<li><a href="#0" class="main-btn primary-btn-light btn-hover"
			id="quizSelect">문제선택</a></li>
	</ul>
</div>

<div id="quizBox" class="container"></div>

<button id="updateBtn">아작스테스트</button>

<!-- 문제 상세보기 모달창 -->
<div id="modalWrap" class="modal-overlay"></div>
<!-- 문제 상세보기 모달창 end-->

<!-- 과목추가/삭제 모달창 -->
<div id="modalWrap2" class="modal-overlay">
	<div id="modalBody2">
		<div class="close-area">X</div>
		<div class="input-style-1">
			<!-- ======= checkbox style start ======= -->
			<div class="card-style mb-30">
				<h6 class="mb-25">과목 설정</h6>
				<th:block th:each="subjectInfo, idxStat : ${subjectList}">
					<div class="form-check checkbox-style mb-20">
						<table>
							<tr>
								<th><input class="form-check-input checkbox"
									th:id="${subjectInfo.subjectName}" type="checkbox"
									th:value="${subjectInfo.subjectId}" th:name="chkBox" /> <label
									th:for="${subjectInfo.subjectName}" class="form-check-label">[[${subjectInfo.subjectName}]]</label>
								</th>
							</tr>
						</table>
					</div>
				</th:block>
			</div>
			<button type="button"
				class="main-btn danger-btn-light square-btn btn-hover" id="testBtn">삭제</button>
			<!-- ======= checkbox style end ======= -->
		</div>
		<form th:action="@{/subjectinsert}" method="post"
			th:object="${teacherVO}">
			<div>
				<div class="input-style-1">
					<input type="text" placeholder="과목명을 입력하세요" th:field=*{subjectName}></input>
				</div>
				<button id="subAdd" class="main-btn primary-btn btn-hover"
					type="submit">과목추가</button>
			</div>
		</form>
	</div>
</div>
<!-- 과목추가 모달창 end -->
<script>
var subName = ''; // 탬플릿문법안에 들어가있는 변수
var qContent = '';
var qId, sId = 0;
var solution = '';
var answer = [];
var sName = ''; // 필터링에 사용될 과목명
var textContent1 = '';
var textContent2 = '';
var textContent3 = '';
var textContent4 = '';
var textContent5 = '';
var answerList = '${answerList}';
var answer1 = '';

// 퀴즈 문제 전체를 불러오는 AJAX
function quizContentList(sName){
	$('#quizBox').html('');
	// 문제 전체 조회 ajax
	$.ajax({
		url : "quizlist",
		type : "post", 
		data : {sName : sName},
				
		success : function(data){
			data.forEach((item,idx) => {
				let rowTag = null;
				if(idx%3==0){
					rowTag = $(`<div id='row${idx}' class='row'></div>`);
					$("#quizBox").append(rowTag);
				}else{
					let num = Math.floor(idx/3) * 3;
					rowTag = $('#row' + num );
				}
				subName = item.subjectName;				
				qContent = item.quizContent;
				qId = item.quizId;
				sId = item.subjectId;
				// template 문법 사용. 직관적으로 생성되는 태그 확인.				
				let temp = `
					<div style="color:gray;" class="col-4 box" id="${sId}">
						<div class="card-style-3 mb-30 box2">
							<div class=chkDiv>
							<label>문제선택</label><input type="checkbox" class="quizChk" name="select"></input>
							<p>과목명 : ${subName}</p>
							</div>
							<div class="card-content">
								<h4>${qContent}</h4>
								<br>
								<button type="button" class="infoBtn" name="${qId}" value="${qId}" id="qid${qId}">자세히 보기</button>
							</div>
						</div>
					</div>
					`;
				//$("#quizBox").append(temp);
				rowTag.append(temp);
			}); // forEach 종료
			
			// 문제 체크박스 버튼 누르고 문제선택 누를시 문제박스 색상 변경
			$('#quizSelect').on('click', function(e){
				$("input:checkbox[name=select]:checked").each(function(){
					$("input:checkbox[name=select]:checked").parent().parent().attr("style", "border-color:blue;")
				})
			})
				
			// 단건 조회 문제 불러오는(자세히보기 버튼) 함수 (ajax)
			$('.box').on('click', '.infoBtn', function(qId) {
				$("#modalWrap").empty(); // 최초로 모달창 비워주는 기능 필요
				qId = $(this).val()
				// 지문 불러오기
				answer = []; // 배열값 초기화
				$.ajax({
					url : "textcontent",
					type : "post", 
					data : {qId : qId},
									
					success : function(data){
						data.forEach((item,idx) => {
							answer.push(item.textContent);
						})
						textContent1 = answer[0];
						textContent2 = answer[1];
						textContent3 = answer[2];
						textContent4 = answer[3];
						textContent5 = answer[4];
						//console.log(answer);
								
						// 문제,해설 불러오기
						$.ajax({
							url : "quizinfo",
							type : "post", 
							data : {qId : qId},
											
							success : function(data){
								data.forEach((item,idx) => {
									solution = item.quizSolution;
									qContent = item.quizContent;
									let qInfo = `
										<div id="modalBody">
											<div class="close-area">X</div>
												<h4>문제</h4><input type="text">${qContent}</input>
											<br><br><br>
											<div>
												<h4>보기</h4>
												<input type="text" id="textContent1">${textContent1}</input>
												<input type="text" id="textContent2">${textContent2}</input>
												<input type="text" id="textContent3">${textContent3}</input>
												<input type="text" id="textContent4">${textContent4}</input>
												<input type="text" id="textContent5">${textContent5}</input>
											</div>
											<br><br><br>
											<div>
												<h4>해설</h4><input type="text">${solution}</input>
											</div>
											<div style="text-align: center;">
												<button id="closeBtn" class="main-btn primary-btn btn-hover"
													type="button" onclick="location.href='quizlist'">확인</button>
											</div>
										</div>
										`;
									$("#modalWrap").append(qInfo);
								})
							},
							error : function(err){
								console.log('에러입니다');
							}
						}); // 문제,해설 불러오기 end of ajax	
					},
					error : function(err){
						console.log('에러입니다');
					}
				}); // 지문 불러오기 ajax 종료
			})// 단건조회 불러오는(자세히보기 버튼) 함수 종료
				/* $('.box').on('click', '.infoBtn', function(e) {
					console.log(e.target.id);
				}) */
				
			$('#quizBox').on('click', '.infoBtn', function (e) {
				modal.style.display = "flex"; // 버튼 클릭시 모달 보임
			});
			
		},
		error : function(){
			alert('실패');
		}
	}); // 문제 전체 조회 ajax 종료 	
}; // function quizContentList() 종료

//테스트용 버튼 
$('#updateBtn1').on('click', function quizInfo(qId){
	console.log(qId);
	$.ajax({
		url : "quizinfo?quizId="+qId,
		type : "get", 
				
		success : function(data){
			console.log(data);
		},
		error : function(err){
			console.log('에러입니다');
		}
	}); 
})

// 과목추가/삭제시 알림창 뜨는거 테스트
$('#subAdd').on('click',function(){
	if($('#subAdd').submit()){
		alert('과목이 추가되었습니다.')
	} else {
		alert('오류 발생.')
	}
})
$('#testBtn').on('click',function(){
	if($('#testBtn').submit()){
		alert('과목이 삭제되었습니다.')
	} else {
		alert('오류 발생.')
	}
})

// 과목삭제에서 체크박스 누르고 삭제버튼 누를시 삭제되는 기능
$('.form-check').on('click', '.checkbox', function(){
	var chkVal = $(this).val();
	
	$('input[type="checkbox"][name="chkBox"]').click(function(){
		  if($(this).prop('checked')){
		     $('input[type="checkbox"][name="chkBox"]').prop('checked',false);
		     $(this).prop('checked',true);
		    }
	});
	if($(".checkbox").is(":checked")){
		$("#testBtn").attr("onclick", "location.href='/subjectdelete?subjectId=" + chkVal +"'");
	} else {
		$("#testBtn").attr("th:onclick", "");
	};
})

// 모달창 작업
// 모달창 (과목 추가/삭제)
const modalSub = document.getElementById("modalWrap2"); // 과목추가 모달창 요소 가져오기
const modal = document.getElementById("modalWrap"); // 자세히보기 모달창 요소 가져오기


$('#subBtn').on('click', function(e){
	modalSub.style.display = "flex"; // 과목추가/삭제 버튼 클릭시 모달창 보이기
});

// X버튼 누르면 모달창 닫기
$('.modal-overlay').on('click', '.close-area',function (e){
	modal.style.display = "none";
	modalSub.style.display = "none";
});

// 모달창 밖에 화면 누르면 모달창 닫는 기능
modal.addEventListener("click", e => {
	const evTarget = e.target
	if(evTarget.classList.contains("modal-overlay")) {
		modal.style.display = "none"
	}
})
modalSub.addEventListener("click", e => {
    const evTarget = e.target
    if(evTarget.classList.contains("modal-overlay")) {
        modalSub.style.display = "none";
    }
});

// esc누르면 모달창 닫기
window.addEventListener("keyup", e => {
    if(modalSub.style.display === "flex" && e.key === "Escape") {
    	modalSub.style.display = "none"
    } else if(modal.style.display === "flex" && e.key === "Escape") {
    	modal.style.display = "none"
    }  
});
// 모달창 기능 종료

// 과목명 필터링해서 문제 출력
$('#subject').on('change', function(){
	if($(this).val() == 'all'){
		sName = '';
		quizContentList(sName);
	} else {
		sName = $(this).val();
		quizContentList(sName);
	}
});


quizContentList(sName)
</script>

</html>