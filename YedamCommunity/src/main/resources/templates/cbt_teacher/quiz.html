<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/admin_layout}"
	layout:fragment="Admin">
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<style>
#modalWrap {
	position: fixed; /* 화면에 고정 */
	z-index: 1; /* 상위에 위치 */
	padding-top: 200px;
	left: 0;
	top: 0;
	width: 100%;
	height: 100%;
	overflow: auto;
	background-color: rgba(0, 0, 0, 0.7); /* 반투명한 배경색 */
	display: none; /* 초기에는 숨김 */
}

#modalWrap2 {
	position: fixed; /* 화면에 고정 */
	z-index: 1; /* 상위에 위치 */
	padding-top: 200px;
	left: 0;
	top: 0;
	width: 100%;
	height: 100%;
	overflow: auto;
	background-color: rgba(0, 0, 0, 0.7); /* 반투명한 배경색 */
	display: none; /* 초기에는 숨김 */
}

#modalBody {
	width: 50%;
	height: 70%;
	padding: 30px 30px;
	margin: 0 auto;
	border: 1px solid #777;
	background-color: #fff;
}

#modalBody2 {
	width: 50%;
	height: 90%;
	padding: 30px 30px;
	margin: 0 auto;
	border: 1px solid #777;
	background-color: #fff;
}

.close-area {
	display: inline;
	float: right;
	padding-right: 10px;
	cursor: pointer;
	color: black;
}

li {
	display: inline;
}
</style>
<!-- <p th:text="${answerList}"></p>  -->
<div>
	<button type="button" id="subBtn"
		class="main-btn primary-btn-light btn-hover">과목 추가/삭제</button>
	<ul>
		<li>
			<div id="subSelec">
				<label>과목선택</label>
				<div class="select-position">
					<select id="subject">
						<option value="all">전체보기</option>
						<th:block th:each="subjectInfo, idxStat : ${subjectList}">
							<option class="typeSelec" th:value="${subjectInfo.subjectName}">[[${subjectInfo.subjectName}]]</option>
						</th:block>
					</select>
				</div>
			</div>
		</li>
		<li><a href="selectClassExam" id="testInsert"
			class="main-btn danger-btn-light btn-hover">시험출제</a></li>
		<li><a href="quizinsert"
			class="main-btn primary-btn-light btn-hover">새문제</a></li>
		<li><a href="#0" class="main-btn primary-btn-light btn-hover"
			id="quizSelect">문제선택</a></li>
	</ul>
</div>

<div id="quizBox" class="container"></div>



<button id="updateBtn">아작스테스트</button>

<!-- 문제 상세보기 모달창 -->
<div id="modalWrap" class="modal-overlay"></div>
<!-- 문제 상세보기 모달창 end-->

<!-- 과목추가/삭제 모달창 -->
<div id="modalWrap2" class="modal-overlay">
	<div id="modalBody2">
		<div class="close-area">X</div>
		<div class="input-style-1">
			<!-- 과정 선택창 -->
			<label>과정 선택</label>
				<div class="select-position">
					<select id="curr">
						<th:block th:each="currInfo, idxStat : ${currList}">
							<option class="typeSelec" th:value="${currInfo.curriculumId}" th:name="${currInfo.curriculumId}">[[${currInfo.curriculumName}]] - [[${currInfo.classId}]]강의실</option>
						</th:block>
					</select>
				</div>
		<form th:action="@{/subjectdelete}" id="delForm" name="delForm" method="get" th:object="${teacherVO}">
			<div class="card-style mb-30">
				<h6 class="mb-25">과목 설정</h6>
				<div class="form-check checkbox-style mb-20 currSub">
				</div>
				<input type="hidden" id="hidden" name="curriculumId"/>	
			</div>
			<button type="submit"
				class="main-btn danger-btn-light square-btn btn-hover" id="delBtn" formaction="subjectdelete">삭제</button>
		</form>	
		</div>
		<form th:action="@{/subjectinsert}" id="insertForm" name="insertForm" method="post" th:object="${teacherVO}">
			<div>
				<div class="input-style-1">
					<input type="text" id="insertSubName" placeholder="과목명을 입력하세요" th:field=*{subjectName}></input>
					<input type="hidden" id="insertSub"></input>
				</div>
				<button id="subAdd" class="main-btn primary-btn btn-hover"
					type="submit">과목추가</button>
			</div>
		</form>
	</div>
</div>
<!-- 과목추가 모달창 end -->
<script>
var subName = ''; // 탬플릿문법안에 들어가있는 변수
var qContent = '';
var qId, sId= 0;
var curriId = 0;
var solution = '';
var answer = [];
var sName = ''; // 필터링에 사용될 과목명
var textContent1 = '';
var textContent2 = '';
var textContent3 = '';
var textContent4 = '';
var textContent5 = '';
var storageContent = [];
var storageScore = []; 
var storageQId = [];

//--------------------------------------------
// 퀴즈 문제 전체를 불러오는 함수
//--------------------------------------------
function quizContentList(sName){
	$('#quizBox').html('');
	//--------------------------------------------
	// 문제 전체 조회 ajax (필터링)
	//--------------------------------------------
	$.ajax({
		url : "quizes",
		type : "get", 
		data : {sName : sName},
		async: false,		
		success : function(data){
			//--------------------------------------------
			// 문제 전체 퀴즈박스 생성 forEach 시작
			//--------------------------------------------
			data.forEach((item,idx) => {
				let rowTag = null;
				if(idx%3==0){
					rowTag = $(`<div id='row${idx}' class='row'></div>`);
					$("#quizBox").append(rowTag);
				}else{
					let num = Math.floor(idx/3) * 3;
					rowTag = $('#row' + num );
				}
				subName = item.subjectName;				
				qContent = item.quizContent;
				qId = item.quizId;
				sId = item.subjectId;
				
				let temp = `
					<div style="color:gray;" class="col-4 box" id="${qId}">
						<div class="card-style-3 mb-30 box2">
							<div>
								<label>문제선택
									<input type="checkbox" class="quizChk " name="select"  id="qContent${idx}" value="${qContent}"></input>
								</label>
								<input type="text" class="scInput" placeholder="배점입력" id="qScore${idx}" style="border:1px solid black;">
								<p>과목명 : ${subName}</p>
								<input type="hidden" id="qId${idx}" value="${qId}" />
							</div>
							<div class="card-content">
								<h4>${qContent}</h4>
								<br>
								<button type="button" class="infoBtn" name="${qId}">자세히 보기</button>
							</div>
						</div>
					</div>
					`;
				//$("#quizBox").append(temp);
				rowTag.append(temp);
			});
			//--------------------------------------------
			// 문제 전체 퀴즈박스 생성 forEach 종료
			//--------------------------------------------
			
			//--------------------------------------------
			// 문제 체크박스 버튼 누르고 문제선택 누를시 문제박스 색상 변경.
			//--------------------------------------------
			$('#quizSelect').on('click', function(e){
				$("input:checkbox[name=select]:checked").each(function(){
					$("input:checkbox[name=select]:checked").parent().parent().attr("style", "border-color:blue;")
				})
			})
			
			//--------------------------------------------	
			// 단건 조회 문제 불러오는(자세히보기 버튼) 함수 (ajax 포함) 시작
			//--------------------------------------------
			$('.box').on('click', '.infoBtn', function(qId) {
				$("#modalWrap").empty(); // 최초로 모달창 비워주는 기능 필요
				qId = $(this).val()
				answer = []; // 배열값 초기화
				//--------------------------------------------
				// 지문 자세히보기 - 모달에 불러오기 시작
				//--------------------------------------------
				$.ajax({
					url : "answers",
					type : "get", 
					data : {qId : qId},
									
					success : function(data){
						data.forEach((item,idx) => {
							answer.push(item.textContent);
						})
						textContent1 = answer[0];
						textContent2 = answer[1];
						textContent3 = answer[2];
						textContent4 = answer[3];
						textContent5 = answer[4];
						
						//--------------------------------------------
						// 문제,해설 단건조회(자세히보기)ajax - 모달에 불러오기 시작
						//--------------------------------------------
						$.ajax({
							url : "quizinfo",
							type : "get", 
							data : {qId : qId},
											
							success : function(data){
								data.forEach((item,idx) => {
									solution = item.quizSolution;
									qContent = item.quizContent;
									let qInfo = `
										<div id="modalBody">
											<div class="close-area">X</div>
												<h4>문제</h4><input type="text">${qContent}</input>
											<br><br><br>
											<div>
												<h4>보기</h4>
												<input type="text" id="textContent1">${textContent1}</input>
												<input type="text" id="textContent2">${textContent2}</input>
												<input type="text" id="textContent3">${textContent3}</input>
												<input type="text" id="textContent4">${textContent4}</input>
												<input type="text" id="textContent5">${textContent5}</input>
											</div>
											<br><br><br>
											<div>
												<h4>해설</h4><input type="text">${solution}</input>
											</div>
											<div style="text-align: center;">
												<button id="closeBtn" class="main-btn primary-btn btn-hover"
													type="button" onclick="location.href='quizlist'">확인</button>
											</div>
										</div>
										`;
									$("#modalWrap").append(qInfo);
								})
							},
							error : function(err){
								console.log('에러입니다');
							}
						});
						//--------------------------------------------
						// 문제,해설 단건조회(자세히보기)ajax - 모달에 불러오기 종료
						//--------------------------------------------
					},
					error : function(err){
						console.log('에러입니다');
					}
				});
				//--------------------------------------------
				// 지문 자세히보기 - 모달에 불러오기 종료
				//--------------------------------------------
			})
			//--------------------------------------------	
			// 단건 조회 문제 불러오는(자세히보기 버튼) 함수 (ajax 포함)
			//--------------------------------------------
			
			/* $('.box').on('click', '.infoBtn', function(e) {
				console.log(e.target.id);
			}) */
			
			//--------------------------------------------	
			// 자세히 보기 버튼 눌렀을때 모달창 띄우기
			//--------------------------------------------
			$('#quizBox').on('click', '.infoBtn', function (e) {
				modal.style.display = "flex"; // 버튼 클릭시 모달 보임
			});
		},
		error : function(){
			alert('실패');
		}
	});
	//--------------------------------------------
	// 문제 전체 조회 ajax (필터링) 종료
	//--------------------------------------------
};
//--------------------------------------------
//퀴즈 문제 전체를 불러오는 함수 종료
//--------------------------------------------

//--------------------------------------------
// 과목 추가/삭제 모달창에서 과목창 띄워주는 함수
//--------------------------------------------
function subList(curriId){
	curriId = $('#curr').val();
	$('#insertSub').val(curriId);
	$('#insertSub').attr('name','curriculumId');
	$.ajax({
		url : "subjectCurrList",
		type : "post",
		data : {curriId : curriId},
		
		success : function(data){
			$('.currSub').html('');
			data.forEach((item,idx) => {
				
				let subjectName = item.subjectName;
				let templ = `
					<table>
						<tr>
							<th><input class="form-check-input checkbox"
								id="${subjectName}" type="checkbox"
								value="${subjectName}" name="subjectName" /> <label
								for="${subjectName}" class="form-check-label">${subjectName}</label>
							</th>
						</tr>
					</table>`;
				$('.currSub').append(templ);
			})
		},
		error : function(err){
			console.log('에러입니다');
		}
	}); 
}
subList(curriId);
//--------------------------------------------
//과목 추가/삭제 모달창에서 과정명이 바뀌면 과목명도 같이 바뀌는 필터, curriculumId값 자동 등록.
//--------------------------------------------
$('#curr').on('change', function(){
		curriId = $(this).val();
		$('#insertSub').val(curriId);
		$('#insertSub').attr('name','curriculumId');
		subList(curriId);
});
//--------------------------------------------
// 과목추가/삭제모달 알림창 뜨는거
//--------------------------------------------
document.querySelector('form[name="insertForm"]')
				.addEventListener('submit', validationCheck);
function validationCheck(event){
	event.preventDefault();
	if($('#insertSubName').val() == ''){
		alert('과목명을 입력해 주세요.');
		$('#insertSubName').focus();
		return;
	} else {
		alert('과목이 추가되었습니다');
		$('#insertForm').submit();
	}
}


$('#delBtn').on('click',function(){
	if($('#delBtn').submit()){
		//alert('과목이 삭제되었습니다.')
	} else {
		alert('오류 발생.')
	}
})

//--------------------------------------------
// 과목삭제에서 체크박스 누르고 삭제버튼 누를시 삭제되는 기능
//--------------------------------------------
$('.form-check').on('click', '.checkbox', function(){
	var chkVal = $(this).val();
	console.log(chkVal);
	console.log(curriId);
	$('input[type="checkbox"][name="subjectName"]').click(function(){
		  if($(this).prop('checked')){
		     $('input[type="checkbox"][name="subjectName"]').prop('checked',false);
		     $(this).prop('checked',true);
		    }
	});
	if($(".checkbox").is(":checked")){
		$('#hidden').val(curriId);
		$("#delBtn").attr("onclick", "location.href='/subjectdelete?subjectName=" + chkVal + '&curriculumId='+ curriId +"'");
		
	} else if($(".checkbox").is(":checked") == false){
		$("#delBtn").attr("onclick", "");
	};
})															

//--------------------------------------------
// 모달창 작업
//--------------------------------------------
// 모달창 (과목 추가/삭제)
//--------------------------------------------
const modalSub = document.getElementById("modalWrap2"); // 과목추가 모달창 요소 가져오기
const modal = document.getElementById("modalWrap"); // 자세히보기 모달창 요소 가져오기


$('#subBtn').on('click', function(e){
	modalSub.style.display = "flex"; // 과목추가/삭제 버튼 클릭시 모달창 보이기
});
//--------------------------------------------
// X버튼 누르면 모달창 닫기
//--------------------------------------------
$('.modal-overlay').on('click', '.close-area',function (){
	modal.style.display = "none";
	modalSub.style.display = "none";
});
//--------------------------------------------
// 모달창 밖에 화면 누르면 모달창 닫는 기능
//--------------------------------------------
modal.addEventListener("click", e => {
	const evTarget = e.target
	if(evTarget.classList.contains("modal-overlay")) {
		modal.style.display = "none"
	}
})
modalSub.addEventListener("click", e => {
    const evTarget = e.target
    if(evTarget.classList.contains("modal-overlay")) {
        modalSub.style.display = "none";
    }
});
//--------------------------------------------
// esc누르면 모달창 닫기
//--------------------------------------------
window.addEventListener("keyup", e => {
    if(modalSub.style.display === "flex" && e.key === "Escape") {
    	modalSub.style.display = "none";
    } else if(modal.style.display === "flex" && e.key === "Escape") {
    	modal.style.display = "none"
    }  
});
//--------------------------------------------
// 모달창 기능 종료
//--------------------------------------------

//--------------------------------------------
// 과목명 필터링해서 문제 출력
//--------------------------------------------
$('#subject').on('change', function(){
	if($(this).val() == 'all'){
		sName = '';
		quizContentList(sName);
	} else {
		sName = $(this).val();
		quizContentList(sName);
	}
});

quizContentList(sName);

//--------------------------------------------
// 시험출제 버튼 누르면 선택된 문제들이 localstorage에 저장되고 페이지가 넘어감.
//--------------------------------------------
$('#testInsert').on('click', function(){
	storageContent = [];
	storageScore = [];
	storageQId = [];
	window.localStorage.clear();
	//console.log($('.quizChk').is(":checked"));
	for(let i=0; i<$('.box').length; i++){
		if($('#qContent'+i).is(":checked")){
			storageContent.push($('#qContent'+i).val());
			storageScore.push($('#qScore'+i).val());
			storageQId.push($('#qId'+i).val());
		}
	}
	// 값 저장시 ["","",""] 배열타입으로 저장하기 위해 변환작업.
	const arryContent = JSON.stringify(storageContent);
	const arryScore = JSON.stringify(storageScore); 
	const arryQid = JSON.stringify(storageQId);
	
	// 위 작업 안하면 값 출력시 그냥 1,2,3 이런식으로 출력됨
	// 위 작업을 하게 될 경우 ["1","2","3"] 이렇게 출력됨
	window.localStorage.setItem('quizContent', arryContent);
	window.localStorage.setItem('quizScore', arryScore);
	window.localStorage.setItem('quizId', arryQid);
})



</script>

</html>