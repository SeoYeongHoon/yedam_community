<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/admin_layout}"
	layout:fragment="Admin">
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
	
<style>
	.tresult_1 {
		display: inline-block;
	}
	.tresult_2 {
		text-align: center;
	}
	.tresult_3 {
		width: 150px;
	}
	.tresult_4 {
		display: block;
	}
	.true {
		color: blue;
	}
	.false {
		color: red;
	}
</style>	
<div class="row">
	<div class="col-6">
		<div class="address-item">
			<input type="hidden"/>
			<h1 th:text="${testInfo.classId}+'강의실'">n강의실</h1>
			<br>
			<h4 th:text="${testInfo.curriculumName}">과정명</h4>
			<p class="text-sm">
				<span class="text-medium" th:text="${#dates.format(testInfo.curriculumStartDate, 'yyyy.MM.dd')}+'~'+${#dates.format(testInfo.curriculumEndDate, 'yyyy.MM.dd')}">시험기간</span>
			</p>
		</div>
		<div class="title mt-30 mb-30">
			<input id="testIdInfo" type="hidden" th:value="${testInfo.testId}">
			<h2 th:text="${testInfo.testName}+' '+${#dates.format(testInfo.testDate, 'yyyy.MM.dd')}">시험명 시작기간~종료기간</h2>
		</div>
		<div th:if="${userInfo.isReexam} == 0">
			<h2 th:text="${userInfo.name}+' / '+${userInfo.resultScore}+'점 / 재시험 O'"></h2>
		</div>
		<div th:if="${userInfo.isReexam} == 1">
			<h2 th:text="${userInfo.name}+' / '+${userInfo.resultScore}+'점 / 재시험 X'"></h2>
		</div>
	</div>
	<!-- end col -->
</div>
<!-- 피드백 작성폼 -->
<div class="feedback_form">
	<form th:action="@{/feedupdate}" method="post" th:object="${userInfo}">
		<div class="col-12">
			<h3 style="color: white; margin-bottom: 10px;">피드백 작성란</h3>
			<input type="hidden" th:field="*{resultId}">
			<textarea cols="100" rows="6" placeholder="피드백을 입력하세요" th:field="*{feedback}"></textarea>
			<ul class="buttons-group">
				<li>
					<button type="button" style="background-color: #e96b56; padding: 8px 25px;" class="main-btn primary-btn btn-hover" id="updateBtn">저장</button>
				</li>
				<li>
					<button type="button" style="color: black; padding: 8px 16px;" id="backToTest" class="main-btn deactive-btn btn-hover">뒤로가기</button>
				</li>
			</ul>
		</div>
	</form>
</div>
<!-- 해당학생의 틀린 문제 리스트 -->
<div style="display: flex; flex-wrap: wrap;">
	<th:block th:each="quiz, idx : ${quizResultList}" th:if="${quiz.isCorrect == 0}">
		<div class="feedback_std_test">
			<h1 class="tresult_1">[[${idx.count}]].</h1>
			<img src="/images/icons/false.png" style="position: absolute; left: -10px; top: -30px; width: 100px; height: 100px;">
			<h1 class="tresult_1">[[${quiz.quizContent}]]</h1>
			<p class="tresult_1">([[${quiz.quizScore}]]점)</p>
			<div>
				<p>보기번호 정답/오답 표시</p>
				<span class="tresult_4" th:classappend="${quiz.exampleNum == 1 ? 'true' : (quiz.exampleNum != 1 && quiz.testAnswer == 1)? 'false':_}">[[${quiz.one}]]</span>
				<span class="tresult_4" th:classappend="${quiz.exampleNum == 2 ? 'true' : (quiz.exampleNum != 2 && quiz.testAnswer == 2)? 'false':_}">[[${quiz.two}]]</span>
				<span class="tresult_4" th:classappend="${quiz.exampleNum == 3 ? 'true' : (quiz.exampleNum != 3 && quiz.testAnswer == 3)? 'false':_}">[[${quiz.three}]]</span>
				<span class="tresult_4" th:classappend="${quiz.exampleNum == 4 ? 'true' : (quiz.exampleNum != 4 && quiz.testAnswer == 4)? 'false':_}">[[${quiz.four}]]</span>
				<span class="tresult_4" th:classappend="${quiz.exampleNum == 5 ? 'true' : (quiz.exampleNum != 5 && quiz.testAnswer == 5)? 'false':_}">[[${quiz.five}]]</span>
			</div>
			<hr>
			<h3>풀이</h3>	
			<p>정답: [[${quiz.exampleNum}]]</p>
			<br>
			<p>[[${quiz.quizSolution}]]</p>
		</div>
	</th:block>
</div>

<script>
$('#updateBtn').on('click', updateAjaxJq);

var testIdInfo = $('#testIdInfo').val();

$('#backToTest').on('click', () => {
	location.href = "/admin/testinfo?testId=" + testIdInfo;
})

function updateAjaxJq(event){
	// Validation check
	if(!validationCheck()) return;
	
	// 보낼 데이터 정리
	let dataObj = getEmpObj();
	console.log(dataObj);
	// Ajax
	$.ajax('feedupdate',{
		type : 'post',
		//data : dataObj	QueryString방식
		contentType : 'application/json',	//json방식
		data : JSON.stringify(dataObj)	//json방식
	})
	.done(result =>{
		if(result != null){
			alert('피드백이 등록(수정)되었습니다.');
			location.href="/admin/testinfo?testId=" + testIdInfo;
		}else{
			alert('등록(수정)되지 않았습니다.\n확인해주세요.');
		}
	})
	.fail(err => console.log(err));
};

function validationCheck(){
	let feed = $('#feedback');
	if(feed.val() == ''){
		alert('피드백 내용은 필수로 입력해야합니다.');
		feed.focus();
		return false;
	}
	
	return true;
}

function getEmpObj(){
	let formAry = $('form').serializeArray();	//시리얼라이즈는 폼태그만 작동함.
	// [{ name : 'employeeId', value : '209' },
	//	{ name : 'lastName', value : 'Kang'}, ...]
	
	let formObj = {};
	formAry.forEach(inputTag => {
		formObj[inputTag.name] = inputTag.value;
	})
	// {employeeId : '209', lastName : 'Kang', ...}
	
	return formObj;
}
</script>
</html>